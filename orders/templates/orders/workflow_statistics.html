{% extends 'base.html' %}
{% load static %}
{% load order_filters %}

{% block title %}Workflow Statistics{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-slate-100 to-slate-200">
    <!-- Enhanced Dashboard Header -->
    <div class="relative overflow-hidden bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 border-b border-amber-500/20 shadow-2xl">
        <div class="absolute inset-0 bg-gradient-to-r from-amber-500/10 via-yellow-500/10 to-amber-500/10"></div>
        <div class="relative max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
                <div class="flex items-center space-x-4">
                    <a href="{% url 'orders:list' %}" class="text-white hover:text-amber-100 transition-colors duration-200">
                        <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </a>
                    <div class="w-16 h-16 bg-gradient-to-br from-amber-400 via-yellow-500 to-amber-600 rounded-2xl flex items-center justify-center shadow-2xl shadow-amber-500/25">
                        <i class="fas fa-chart-line text-3xl text-slate-900"></i>
                    </div>
                    <div>
                        <h1 class="text-4xl lg:text-5xl font-bold bg-gradient-to-r from-amber-400 via-yellow-300 to-amber-400 bg-clip-text text-transparent">
                            Workflow Statistics
                        </h1>
                        <p class="mt-2 text-lg text-slate-300 font-medium">Comprehensive analytics and insights into order workflow performance</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 space-y-8">
        <!-- Overall Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl border border-slate-200/50 p-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-shopping-cart text-white text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-slate-600">Total Orders</p>
                        <p class="text-2xl font-bold text-slate-900">{{ total_orders }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl border border-slate-200/50 p-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-br from-green-400 to-green-600 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-check-circle text-white text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-slate-600">Completed Orders</p>
                        <p class="text-2xl font-bold text-slate-900">{{ workflow_counts.delivery_completed|default:0 }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl border border-slate-200/50 p-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-br from-amber-400 to-amber-600 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-clock text-white text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-slate-600">In Progress</p>
                        <p class="text-2xl font-bold text-slate-900">
                            {% with in_progress=workflow_counts.seller_submitted|default:0|add:workflow_counts.callcenter_approved|default:0|add:workflow_counts.stockkeeper_approved|default:0|add:workflow_counts.packaging_in_progress|default:0|add:workflow_counts.packaging_completed|default:0|add:workflow_counts.delivery_in_progress|default:0 %}
                                {{ in_progress }}
                            {% endwith %}
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl border border-slate-200/50 p-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-400 to-purple-600 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-percentage text-white text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-slate-600">Completion Rate</p>
                        <p class="text-2xl font-bold text-slate-900">
                            {% if total_orders > 0 %}
                                {% with completed=workflow_counts.delivery_completed|default:0 %}
                                    {% with rate=completed|div:total_orders|mul:100 %}
                                        {{ rate|floatformat:1 }}%
                                    {% endwith %}
                                {% endwith %}
                            {% else %}
                                0%
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workflow Stage Breakdown -->
        <div class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl border border-slate-200/50 overflow-hidden">
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 px-6 py-6 border-b border-slate-600/50">
                <h3 class="text-2xl font-bold text-white">Workflow Stage Breakdown</h3>
                <p class="text-slate-300 mt-2">Orders currently in each workflow stage</p>
            </div>
            <div class="p-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    {% for stage_code, stage_name in workflow_stages %}
                    <div class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-2xl p-6 border border-slate-200/50 text-center">
                        <div class="w-16 h-16 {% if stage_code == 'seller_submitted' %}bg-gradient-to-br from-slate-400 to-slate-600{% elif stage_code == 'callcenter_approved' %}bg-gradient-to-br from-blue-400 to-blue-600{% elif stage_code == 'stockkeeper_approved' %}bg-gradient-to-br from-green-400 to-green-600{% elif stage_code == 'packaging_in_progress' %}bg-gradient-to-br from-yellow-400 to-amber-600{% elif stage_code == 'packaging_completed' %}bg-gradient-to-br from-amber-400 to-orange-600{% elif stage_code == 'delivery_in_progress' %}bg-gradient-to-br from-purple-400 to-purple-600{% else %}bg-gradient-to-br from-green-400 to-green-600{% endif %} rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                            {% if stage_code == 'seller_submitted' %}
                                <i class="fas fa-user text-2xl text-white"></i>
                            {% elif stage_code == 'callcenter_approved' %}
                                <i class="fas fa-phone text-2xl text-white"></i>
                            {% elif stage_code == 'stockkeeper_approved' %}
                                <i class="fas fa-boxes text-2xl text-white"></i>
                            {% elif stage_code == 'packaging_in_progress' %}
                                <i class="fas fa-box text-2xl text-white"></i>
                            {% elif stage_code == 'packaging_completed' %}
                                <i class="fas fa-box-open text-2xl text-white"></i>
                            {% elif stage_code == 'delivery_in_progress' %}
                                <i class="fas fa-truck text-2xl text-white"></i>
                            {% else %}
                                <i class="fas fa-check-circle text-2xl text-white"></i>
                            {% endif %}
                        </div>
                        <div class="text-3xl font-bold text-slate-900 mb-2">{{ workflow_counts|get_item:stage_code|default:0 }}</div>
                        <div class="text-sm text-slate-600 font-medium">{{ stage_name }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Recent Workflow Activity -->
        <div class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl border border-slate-200/50 overflow-hidden">
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 px-6 py-6 border-b border-slate-600/50">
                <h3 class="text-2xl font-bold text-white">Recent Workflow Activity</h3>
                <p class="text-slate-300 mt-2">Latest workflow status changes and updates</p>
            </div>
            <div class="p-6">
                {% if recent_logs %}
                <div class="space-y-4">
                    {% for log in recent_logs %}
                    <div class="flex items-center space-x-4 p-4 bg-gradient-to-r from-slate-50 to-slate-100 rounded-2xl border border-slate-200/50 hover:shadow-lg transition-all duration-200">
                        <div class="w-12 h-12 bg-gradient-to-br from-amber-400 to-yellow-500 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                            <i class="fas fa-exchange-alt text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <h4 class="text-lg font-semibold text-slate-900">
                                    Order #{{ log.order.order_code }} - {{ log.order.customer|default:"Unknown Customer" }}
                                </h4>
                                <span class="text-sm text-amber-600 font-medium">{{ log.timestamp|date:"M d, Y H:i" }}</span>
                            </div>
                            <p class="text-slate-600 mt-1">
                                <span class="font-medium">{{ log.get_from_status_display }}</span>
                                <i class="fas fa-arrow-right mx-2 text-amber-500"></i>
                                <span class="font-medium">{{ log.get_to_status_display }}</span>
                            </p>
                            <p class="text-slate-500 mt-1">
                                Updated by: {{ log.user.get_full_name|default:log.user.username }}
                                {% if log.notes %}
                                <span class="ml-2 text-amber-600">â€¢ {{ log.notes }}</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-12">
                    <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-info-circle text-3xl text-slate-400"></i>
                    </div>
                    <h3 class="text-lg font-medium text-slate-900 mb-2">No Recent Activity</h3>
                    <p class="text-slate-600">Workflow activity will appear here once orders start moving through the system.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Workflow Performance Metrics -->
        <div class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl border border-slate-200/50 overflow-hidden">
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 px-6 py-6 border-b border-slate-600/50">
                <h3 class="text-2xl font-bold text-white">Workflow Performance Metrics</h3>
                <p class="text-slate-300 mt-2">Key performance indicators and efficiency metrics</p>
            </div>
            <div class="p-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                            <i class="fas fa-tachometer-alt text-3xl text-white"></i>
                        </div>
                        <h4 class="text-lg font-semibold text-slate-900 mb-2">Efficiency</h4>
                        <p class="text-3xl font-bold text-green-600">
                            {% if total_orders > 0 %}
                                {% with completed=workflow_counts.delivery_completed|default:0 %}
                                    {% with rate=completed|div:total_orders|mul:100 %}
                                        {{ rate|floatformat:1 }}%
                                    {% endwith %}
                                {% endwith %}
                            {% else %}
                                0%
                            {% endif %}
                        </p>
                        <p class="text-sm text-slate-600">Orders completed successfully</p>
                    </div>

                    <div class="text-center">
                        <div class="w-20 h-20 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                            <i class="fas fa-stream text-3xl text-white"></i>
                        </div>
                        <h4 class="text-lg font-semibold text-slate-900 mb-2">Flow Rate</h4>
                        <p class="text-3xl font-bold text-blue-600">
                            {% if workflow_counts.seller_submitted|default:0 > 0 %}
                                {% with approved=workflow_counts.callcenter_approved|default:0 %}
                                    {% with submitted=workflow_counts.seller_submitted|default:0 %}
                                        {% with rate=approved|div:submitted|mul:100 %}
                                            {{ rate|floatformat:1 }}%
                                        {% endwith %}
                                    {% endwith %}
                                {% endwith %}
                            {% else %}
                                0%
                            {% endif %}
                        </p>
                        <p class="text-sm text-slate-600">Orders approved by call center</p>
                    </div>

                    <div class="text-center">
                        <div class="w-20 h-20 bg-gradient-to-br from-purple-400 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                            <i class="fas fa-shipping-fast text-3xl text-white"></i>
                        </div>
                        <h4 class="text-lg font-semibold text-slate-900 mb-2">Delivery Ready</h4>
                        <p class="text-3xl font-bold text-purple-600">
                            {% if total_orders > 0 %}
                                {% with ready=workflow_counts.packaging_completed|default:0 %}
                                    {% with rate=ready|div:total_orders|mul:100 %}
                                        {{ rate|floatformat:1 }}%
                                    {% endwith %}
                                {% endwith %}
                            {% else %}
                                0%
                            {% endif %}
                        </p>
                        <p class="text-sm text-slate-600">Orders ready for delivery</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Custom scrollbar for better UX */
    .overflow-x-auto::-webkit-scrollbar {
        height: 8px;
    }
    
    .overflow-x-auto::-webkit-scrollbar-track {
        background: #fef3c7;
        border-radius: 4px;
    }
    
    .overflow-x-auto::-webkit-scrollbar-thumb {
        background: linear-gradient(to right, #f59e0b, #eab308);
        border-radius: 4px;
    }
    
    .overflow-x-auto::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(to right, #d97706, #ca8a04);
    }
</style>
{% endblock %} 