{% extends 'base.html' %}
{% load static %}
{% load order_filters %}
{% load role_filters %}

{% block title %}Create Order{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-plus-circle text-orange-500 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <h1 class="text-2xl font-bold text-orange-500">Create New Order</h1>
                        <p class="text-gray-600">Add a new order to the system</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    {% if request.user|is_seller %}
                    <a href="{% url 'sellers:orders' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Orders
                    </a>
                    {% else %}
                    <a href="{% url 'orders:list' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Orders
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <form method="post" class="space-y-8">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Form Content -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Customer Information -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900 flex items-center">
                                <i class="fas fa-user text-orange-500 mr-2"></i>
                                Customer Information
                            </h3>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="{{ form.customer.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        Customer Name <span class="text-red-500">*</span>
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-user text-gray-400"></i>
                                        </div>
                                        {{ form.customer }}
                                    </div>
                                    {% if form.customer.errors %}
                                        <p class="mt-1 text-sm text-red-600">{{ form.customer.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                
                                <div>
                                    <label for="{{ form.customer_phone.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        Customer Phone <span class="text-red-500">*</span>
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-phone text-gray-400"></i>
                                        </div>
                                        {{ form.customer_phone }}
                                    </div>
                                    {% if form.customer_phone.errors %}
                                        <p class="mt-1 text-sm text-red-600">{{ form.customer_phone.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                
                                <div>
                                    <label for="{{ form.date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        Order Date <span class="text-red-500">*</span>
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-calendar text-gray-400"></i>
                                        </div>
                                        {% if request.user|is_seller %}
                                        <!-- For sellers, show date as read-only -->
                                        <div class="w-full px-4 py-3 pl-10 bg-gray-100 border border-gray-200 rounded-xl text-gray-600 cursor-not-allowed">
                                            {{ form.date.value|date:"d/m/Y"|default:"" }}
                                        </div>
                                        <!-- Hidden field to ensure date is submitted -->
                                        <input type="hidden" name="date" value="{{ form.date.value|date:'Y-m-d H:i:s'|default:'' }}" id="hidden_date_field">
                                        <p class="mt-1 text-xs text-gray-500">Date is automatically set to today</p>
                                        {% else %}
                                        <!-- For admins, show normal date input -->
                                        {{ form.date }}
                                        {% endif %}
                                    </div>
                                    {% if form.date.errors %}
                                        <p class="mt-1 text-sm text-red-600">{{ form.date.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                
                                <!-- Status field - Only show for non-sellers -->
                                {% if not request.user|is_seller %}
                                <div>
                                    <label for="{{ form.status.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        Status
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none z-10">
                                            <i class="fas fa-flag text-gray-400"></i>
                                        </div>
                                        {{ form.status }}
                                    </div>
                                    {% if form.status.errors %}
                                        <p class="mt-1 text-sm text-red-600">{{ form.status.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                {% else %}
                                <!-- For sellers, show status as read-only display -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Status
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-flag text-gray-400"></i>
                                        </div>
                                        <div class="w-full px-4 py-3 pl-10 bg-gray-100 border border-gray-200 rounded-xl text-gray-600">
                                            Pending
                                        </div>
                                    </div>
                                    <p class="mt-1 text-xs text-gray-500">Status will be set to Pending automatically</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Seller Information (Only for Admins) -->
                    {% if not request.user|is_seller %}
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900 flex items-center">
                                <i class="fas fa-store text-orange-500 mr-2"></i>
                                Seller Information
                            </h3>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="{{ form.seller.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        Select Seller <span class="text-red-500">*</span>
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none z-10">
                                            <i class="fas fa-store text-gray-400"></i>
                                        </div>
                                        {{ form.seller }}
                                    </div>
                                    {% if form.seller.errors %}
                                        <p class="mt-1 text-sm text-red-600">{{ form.seller.errors.0 }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <!-- Hidden seller field for sellers -->
                    {{ form.seller }}
                    {% endif %}

                    <!-- Address Information -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900 flex items-center">
                                <i class="fas fa-map-marker-alt text-orange-500 mr-2"></i>
                                Address Information
                            </h3>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="{{ form.city.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        City <span class="text-red-500">*</span>
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none z-10">
                                            <i class="fas fa-city text-gray-400"></i>
                                        </div>
                                        {{ form.city }}
                                    </div>
                                    {% if form.city.errors %}
                                        <p class="mt-1 text-sm text-red-600">{{ form.city.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                
                                <div>
                                    <label for="{{ form.state.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        Area <span class="text-red-500">*</span>
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none z-10">
                                            <i class="fas fa-map-marker-alt text-gray-400"></i>
                                        </div>
                                        {{ form.state }}
                                    </div>
                                    {% if form.state.errors %}
                                        <p class="mt-1 text-sm text-red-600">{{ form.state.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                
                                <div>
                                    <label for="{{ form.street_address.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        Street Address
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none z-10">
                                            <i class="fas fa-road text-gray-400"></i>
                                        </div>
                                        {{ form.street_address }}
                                    </div>
                                    {% if form.street_address.errors %}
                                        <p class="mt-1 text-sm text-red-600">{{ form.street_address.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                
                                <div>
                                    <label for="{{ form.country.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        Country <span class="text-red-500">*</span>
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none z-10">
                                            <i class="fas fa-globe text-gray-400"></i>
                                        </div>
                                        {{ form.country }}
                                    </div>
                                    {% if form.country.errors %}
                                        <p class="mt-1 text-sm text-red-600">{{ form.country.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                
                            </div>
                        </div>
                    </div>

                    <!-- Product Information -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-medium text-gray-900 flex items-center">
                                    <i class="fas fa-box text-orange-500 mr-2"></i>
                                    Product Information
                                </h3>
                                <button type="button" id="add-product-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 flex items-center">
                                    <i class="fas fa-plus mr-2"></i>
                                    Add Product
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div id="products-container">
                                <!-- Initial product row -->
                                <div class="product-row border-b border-gray-200 pb-4 mb-4">
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Product <span class="text-red-500">*</span></label>
                                            <select name="product_ids[]" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500 product-select">
                                                <option value="">Select Product</option>
                                                {% for product in products %}
                                                    <option value="{{ product.id }}" data-price="{{ product.selling_price }}" data-variants="{{ product.product_variant|default:'' }}">
                                                        {{ product.name_en|default:product.name_ar }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Product Variant</label>
                                            <select name="product_variants[]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500 product-variant-select">
                                                <option value="">No Variant</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Quantity <span class="text-red-500">*</span></label>
                                            <input type="number" name="quantities[]" min="1" value="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500 product-quantity">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Unit Price (AED) <span class="text-red-500">*</span></label>
                                            <input type="number" name="prices[]" min="0" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500 product-price">
                                        </div>
                                    </div>
                                    <div class="mt-2 text-right">
                                        <button type="button" class="remove-product text-red-600 hover:text-red-800 text-sm" style="display: none;">
                                            <i class="fas fa-trash mr-1"></i> Remove
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 text-right">
                                <div class="text-lg font-semibold">
                                    Total Price: <span id="total-price" class="text-orange-600">AED 0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900 flex items-center">
                                <i class="fas fa-sticky-note text-orange-500 mr-2"></i>
                                Notes
                            </h3>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="{{ form.notes.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        Customer Notes
                                    </label>
                                    {{ form.notes }}
                                    {% if form.notes.errors %}
                                        <p class="mt-1 text-sm text-red-600">{{ form.notes.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                
                                <div>
                                    <label for="{{ form.internal_notes.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        Internal Notes
                                    </label>
                                    {{ form.internal_notes }}
                                    {% if form.internal_notes.errors %}
                                        <p class="mt-1 text-sm text-red-600">{{ form.internal_notes.errors.0 }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="lg:col-span-1">
                    <!-- Order Summary -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">Order Summary</h3>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4">
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-500">Status</span>
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                        Pending Review
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-500">Total Amount</span>
                                    <span class="text-sm font-semibold text-green-600" id="sidebar-total">AED 0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Agent Assignment (Only for Admins) -->
                    {% if not request.user|is_seller %}
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900 flex items-center">
                                <i class="fas fa-users text-orange-500 mr-2"></i>
                                Agent Assignment
                            </h3>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4">
                                <div>
                                    <label class="flex items-center">
                                        <input type="radio" name="assignment_type" value="auto" checked class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300">
                                        <span class="ml-2 text-sm text-gray-700">Auto Assign</span>
                                    </label>
                                    <p class="text-xs text-gray-500 mt-1">Automatically distribute orders among available agents</p>
                                </div>
                                
                                <div>
                                    <label class="flex items-center">
                                        <input type="radio" name="assignment_type" value="manual" class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300">
                                        <span class="ml-2 text-sm text-gray-700">Manual Assign</span>
                                    </label>
                                    <p class="text-xs text-gray-500 mt-1">Select a specific agent</p>
                                </div>
                                
                                <div id="manual-assignment" style="display: none;">
                                    <label for="{{ form.agent.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        Select Agent
                                    </label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none z-10">
                                            <i class="fas fa-user-tie text-gray-400"></i>
                                        </div>
                                        {{ form.agent }}
                                    </div>
                                    {% if form.agent.errors %}
                                        <p class="mt-1 text-sm text-red-600">{{ form.agent.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                
                                <div id="auto-assignment-info" class="bg-blue-50 border border-blue-200 rounded-md p-3">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-info-circle text-blue-500"></i>
                                        </div>
                                        <div class="ml-3">
                                            <p class="text-sm text-blue-700">
                                                Orders will be automatically distributed among <span id="available-agents-count">0</span> available agents
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <!-- Hidden agent field for sellers - auto assignment only -->
                    <input type="hidden" name="assignment_type" value="auto">
                    {{ form.agent }}
                    {% endif %}

                    <!-- Quick Actions -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">Quick Actions</h3>
                        </div>
                        <div class="p-6 space-y-3">
                            <a href="{% url 'orders:list' %}" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center justify-center">
                                <i class="fas fa-list mr-2"></i>
                                All Orders
                            </a>
                            <button type="button" onclick="document.querySelector('form').reset()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center justify-center">
                                <i class="fas fa-undo mr-2"></i>
                                Reset Form
                            </button>
                        </div>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">Create Order</h3>
                        </div>
                        <div class="p-6 space-y-3">
                            <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-3 rounded-md font-medium transition-colors duration-200 flex items-center justify-center">
                                <i class="fas fa-save mr-2"></i>
                                Create Order
                            </button>
                            <a href="{% url 'orders:list' %}" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-md font-medium transition-colors duration-200 flex items-center justify-center">
                                <i class="fas fa-times mr-2"></i>
                                Cancel
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const productsContainer = document.getElementById('products-container');
    const addProductBtn = document.getElementById('add-product-btn');
    const totalPriceDisplay = document.getElementById('total-price');
    const sidebarTotal = document.getElementById('sidebar-total');
    const assignmentTypeRadios = document.querySelectorAll('input[name="assignment_type"]');
    const manualAssignment = document.getElementById('manual-assignment');
    const autoAssignmentInfo = document.getElementById('auto-assignment-info');
    const availableAgentsCount = document.getElementById('available-agents-count');
    
    // Update prices when product is selected
    productsContainer.addEventListener('change', function(e) {
        if (e.target.name === 'product_ids[]') {
            const productRow = e.target.closest('.product-row');
            const priceInput = productRow.querySelector('.product-price');
            const selectedOption = e.target.options[e.target.selectedIndex];
            
            if (selectedOption.dataset.price) {
                priceInput.value = selectedOption.dataset.price;
            }
            
            updateTotalPrice();
        }
    });
    
    // Update total when quantity or price changes
    productsContainer.addEventListener('input', function(e) {
        if (e.target.classList.contains('product-quantity') || 
            e.target.classList.contains('product-price')) {
            updateTotalPrice();
        }
    });
    
    // Add new product row
    addProductBtn.addEventListener('click', function() {
        const productRows = document.querySelectorAll('.product-row');
        const firstRow = productRows[0];
        const newRow = firstRow.cloneNode(true);
        
        // Reset values
        const selectElement = newRow.querySelector('select');
        selectElement.selectedIndex = 0;
        
        newRow.querySelector('.product-quantity').value = 1;
        newRow.querySelector('.product-price').value = '';
        
        // Show remove button
        newRow.querySelector('.remove-product').style.display = 'inline-block';
        
        // Show remove buttons for all rows if we have more than one
        if (productRows.length === 1) {
            productRows[0].querySelector('.remove-product').style.display = 'inline-block';
        }
        
        productsContainer.appendChild(newRow);
        updateTotalPrice();
    });
    
    // Remove product row
    productsContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-product') || 
            e.target.parentElement.classList.contains('remove-product')) {
            
            const productRows = document.querySelectorAll('.product-row');
            if (productRows.length > 1) {
                const row = e.target.closest('.product-row');
                row.remove();
                
                // If only one row left, hide its remove button
                if (document.querySelectorAll('.product-row').length === 1) {
                    document.querySelector('.product-row .remove-product').style.display = 'none';
                }
                
                updateTotalPrice();
            }
        }
    });
    
    // Handle assignment type change
    assignmentTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'manual') {
                manualAssignment.style.display = 'block';
                autoAssignmentInfo.style.display = 'none';
            } else {
                manualAssignment.style.display = 'none';
                autoAssignmentInfo.style.display = 'block';
            }
        });
    });
    
    // Handle product selection change
    productsContainer.addEventListener('change', function(e) {
        if (e.target.classList.contains('product-select')) {
            const productRow = e.target.closest('.product-row');
            const variantSelect = productRow.querySelector('.product-variant-select');
            const priceInput = productRow.querySelector('.product-price');
            
            // Get selected option
            const selectedOption = e.target.options[e.target.selectedIndex];
            const variants = selectedOption.getAttribute('data-variants');
            const price = selectedOption.getAttribute('data-price');
            
            // Update price
            if (price) {
                priceInput.value = parseFloat(price).toFixed(2);
            }
            
            // Update variants dropdown
            variantSelect.innerHTML = '<option value="">No Variant</option>';
            
            if (variants && variants.trim()) {
                // Split variants by comma and create options
                const variantList = variants.split(',').map(v => v.trim()).filter(v => v);
                variantList.forEach(variant => {
                    const option = document.createElement('option');
                    option.value = variant;
                    option.textContent = variant;
                    variantSelect.appendChild(option);
                });
            }
            
            updateTotalPrice();
        }
    });
    
    // Calculate total price
    function updateTotalPrice() {
        const productRows = document.querySelectorAll('.product-row');
        let total = 0;
        
        productRows.forEach(row => {
            const quantity = parseFloat(row.querySelector('.product-quantity').value) || 0;
            const price = parseFloat(row.querySelector('.product-price').value) || 0;
            total += quantity * price;
        });
        
        totalPriceDisplay.textContent = `AED ${total.toFixed(2)}`;
        sidebarTotal.textContent = `AED ${total.toFixed(2)}`;
    }
    
    // Load available agents count
    function loadAvailableAgentsCount() {
        fetch('/api/available-agents-count/')
            .then(response => response.json())
            .then(data => {
                availableAgentsCount.textContent = data.count;
            })
            .catch(error => {
                console.error('Error loading agents count:', error);
                availableAgentsCount.textContent = '0';
            });
    }
    
    // Initialize
    updateTotalPrice();
    loadAvailableAgentsCount();
    
    // Ensure date is set for sellers
    {% if request.user|is_seller %}
    document.addEventListener('DOMContentLoaded', function() {
        const hiddenDateField = document.getElementById('hidden_date_field');
        if (hiddenDateField && !hiddenDateField.value) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            hiddenDateField.value = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
    });
    {% endif %}
    
    const citySelect = document.getElementById('id_city');
    const stateSelect = document.getElementById('id_state');
    
    // City dropdown change handler
    if (citySelect && stateSelect) {
        citySelect.addEventListener('change', function() {
            const selectedCity = this.value;
            
            // Load areas for selected city
            if (selectedCity) {
                loadAreasForCity(selectedCity);
            } else {
                // Clear areas if no city is selected
                stateSelect.innerHTML = '<option value="">Select Area - Please select city first</option>';
                stateSelect.disabled = true;
            }
        });
    }
    
    // Function to load areas for a city
    function loadAreasForCity(cityName) {
        if (!cityName || !stateSelect) {
            return;
        }
        
        // Disable area select while loading
        stateSelect.disabled = true;
        stateSelect.innerHTML = '<option value="">Loading areas...</option>';
        
        // Use the city value (Arabic name) for the API call
        fetch(`/orders/api/get-states-for-city/?city=${encodeURIComponent(cityName)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.states && data.states.length > 0) {
                    // Clear and populate area dropdown
                    stateSelect.innerHTML = '<option value="">Select Area</option>';
                    
                    data.states.forEach(state => {
                        const option = document.createElement('option');
                        option.value = state.value;
                        option.textContent = state.label;
                        stateSelect.appendChild(option);
                    });
                    
                    // Enable area select
                    stateSelect.disabled = false;
                } else {
                    stateSelect.innerHTML = '<option value="">No areas found for this city</option>';
                    stateSelect.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error loading areas:', error);
                stateSelect.innerHTML = '<option value="">Error loading areas. Please try again.</option>';
                stateSelect.disabled = true;
            });
    }
    
    // Initialize area select state
    if (stateSelect) {
        // Disable area select initially if no city is selected
        if (!citySelect || !citySelect.value) {
            stateSelect.disabled = true;
        }
    }
});
</script>
{% endblock %}