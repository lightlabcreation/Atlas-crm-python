{% extends 'base.html' %}
{% load static %}

{% block title %}Order Workflow Details - {{ order.order_code }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-amber-50 via-yellow-50 to-orange-50">
    <!-- Page Header -->
    <div class="bg-gradient-to-r from-amber-600 via-yellow-500 to-orange-500 shadow-2xl">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
                <div class="flex items-center space-x-4">
                    <a href="{% url 'orders:list' %}" class="text-white hover:text-amber-100 transition-colors duration-200">
                        <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </a>
                    <div>
                        <h1 class="text-4xl font-bold text-white mb-2">Order Workflow Details</h1>
                        <p class="text-amber-100 text-lg">Order #{{ order.order_code }} - {{ order.customer|default:"N/A" }}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    {% if can_approve %}
                    <a href="{% url 'orders:workflow_approve' order.id %}" class="bg-white/20 backdrop-blur-sm text-white hover:bg-white/30 px-6 py-3 rounded-2xl font-semibold transition-all duration-200 border border-white/30 shadow-lg hover:shadow-xl">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        {{ approval_action }}
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 space-y-8">
        <!-- Order Summary Card -->
        <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl border border-amber-200/50 overflow-hidden">
            <div class="bg-gradient-to-r from-amber-500 to-yellow-500 px-6 py-4">
                <h3 class="text-xl font-bold text-white">Order Summary</h3>
                <p class="text-amber-100 mt-1">Complete order information and details</p>
            </div>
            <div class="p-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="text-center bg-gradient-to-br from-amber-50 to-yellow-50 rounded-2xl p-6 border border-amber-200">
                        <div class="w-16 h-16 bg-gradient-to-br from-amber-400 to-yellow-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <div class="text-3xl font-bold text-amber-700 mb-2">{{ order.order_code }}</div>
                        <div class="text-sm text-amber-600 font-medium">Order Code</div>
                    </div>
                    
                    <div class="text-center bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-6 border border-green-200">
                        <div class="w-16 h-16 bg-gradient-to-br from-green-400 to-emerald-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                        <div class="text-3xl font-bold text-green-700 mb-2">{{ order.customer|default:"N/A" }}</div>
                        <div class="text-sm text-green-600 font-medium">Customer</div>
                    </div>
                    
                    <div class="text-center bg-gradient-to-br from-purple-50 to-indigo-50 rounded-2xl p-6 border border-purple-200">
                        <div class="w-16 h-16 bg-gradient-to-br from-purple-400 to-indigo-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                            </svg>
                        </div>
                        <div class="text-3xl font-bold text-purple-700 mb-2">{{ order.quantity }}</div>
                        <div class="text-sm text-purple-600 font-medium">Quantity</div>
                    </div>
                    
                    <div class="text-center bg-gradient-to-br from-orange-50 to-red-50 rounded-2xl p-6 border border-orange-200">
                        <div class="w-16 h-16 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
                            </svg>
                        </div>
                        <div class="text-3xl font-bold text-orange-700 mb-2">{{ order.total_price_aed }}</div>
                        <div class="text-sm text-orange-600 font-medium">Total Amount (AED)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workflow Status -->
        <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl border border-amber-200/50 overflow-hidden">
            <div class="bg-gradient-to-r from-amber-500 to-yellow-500 px-6 py-4">
                <h3 class="text-xl font-bold text-white">Current Workflow Status</h3>
                <p class="text-amber-100 mt-1">Track the order through the workflow stages</p>
            </div>
            <div class="p-8">
                <div class="flex flex-col lg:flex-row items-center justify-between space-y-8 lg:space-y-0">
                    <!-- Seller Submitted -->
                    <div class="flex flex-col items-center group">
                        <div class="w-16 h-16 {% if order.workflow_status == 'seller_submitted' %}bg-gradient-to-br from-green-400 to-green-600{% else %}bg-gradient-to-br from-gray-400 to-gray-600{% endif %} rounded-full flex items-center justify-center shadow-lg group-hover:shadow-xl transition-all duration-300 group-hover:scale-110">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                        <span class="text-sm font-semibold {% if order.workflow_status == 'seller_submitted' %}text-green-700{% else %}text-gray-700{% endif %} mt-3">Seller</span>
                        <span class="text-xs {% if order.workflow_status == 'seller_submitted' %}text-green-500{% else %}text-gray-500{% endif %}">Submitted</span>
                    </div>
                    
                    <div class="hidden lg:block flex-1 h-1 {% if order.workflow_status in 'callcenter_approved,stockkeeper_approved,packaging_in_progress,packaging_completed,delivery_in_progress,delivery_completed' %}bg-gradient-to-r from-green-300 to-amber-300{% else %}bg-gradient-to-r from-gray-300 to-amber-300{% endif %} mx-4 rounded-full"></div>
                    <div class="lg:hidden w-1 h-16 {% if order.workflow_status in 'callcenter_approved,stockkeeper_approved,packaging_in_progress,packaging_completed,delivery_in_progress,delivery_completed' %}bg-gradient-to-b from-green-300 to-amber-300{% else %}bg-gradient-to-b from-gray-300 to-amber-300{% endif %} rounded-full"></div>
                    
                    <!-- Call Center -->
                    <div class="flex flex-col items-center group">
                        <div class="w-16 h-16 {% if order.workflow_status in 'callcenter_approved,stockkeeper_approved,packaging_in_progress,packaging_completed,delivery_in_progress,delivery_completed' %}bg-gradient-to-br from-green-400 to-green-600{% elif order.workflow_status == 'seller_submitted' %}bg-gradient-to-br from-blue-400 to-blue-600{% else %}bg-gradient-to-br from-gray-400 to-gray-600{% endif %} rounded-full flex items-center justify-center shadow-lg group-hover:shadow-xl transition-all duration-300 group-hover:scale-110">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                            </svg>
                        </div>
                        <span class="text-sm font-semibold {% if order.workflow_status in 'callcenter_approved,stockkeeper_approved,packaging_in_progress,packaging_completed,delivery_in_progress,delivery_completed' %}text-green-700{% elif order.workflow_status == 'seller_submitted' %}text-blue-700{% else %}text-gray-700{% endif %} mt-3">Call Center</span>
                        <span class="text-xs {% if order.workflow_status in 'callcenter_approved,stockkeeper_approved,packaging_in_progress,packaging_completed,delivery_in_progress,delivery_completed' %}text-green-500{% elif order.workflow_status == 'seller_submitted' %}text-blue-500{% else %}text-gray-500{% endif %}">Approved</span>
                    </div>
                    
                    <div class="hidden lg:block flex-1 h-1 {% if order.workflow_status in 'stockkeeper_approved,packaging_in_progress,packaging_completed,delivery_in_progress,delivery_completed' %}bg-gradient-to-r from-green-300 to-yellow-300{% else %}bg-gradient-to-r from-blue-300 to-green-300{% endif %} mx-4 rounded-full"></div>
                    <div class="lg:hidden w-1 h-16 {% if order.workflow_status in 'stockkeeper_approved,packaging_in_progress,packaging_completed,delivery_in_progress,delivery_completed' %}bg-gradient-to-b from-green-300 to-yellow-300{% else %}bg-gradient-to-b from-blue-300 to-green-300{% endif %} rounded-full"></div>
                    
                    <!-- Stock Keeper -->
                    <div class="flex flex-col items-center group">
                        <div class="w-16 h-16 {% if order.workflow_status in 'stockkeeper_approved,packaging_in_progress,packaging_completed,delivery_in_progress,delivery_completed' %}bg-gradient-to-br from-green-400 to-green-600{% elif order.workflow_status == 'callcenter_approved' %}bg-gradient-to-br from-blue-400 to-blue-600{% else %}bg-gradient-to-br from-gray-400 to-gray-600{% endif %} rounded-full flex items-center justify-center shadow-lg group-hover:shadow-xl transition-all duration-300 group-hover:scale-110">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                            </svg>
                        </div>
                        <span class="text-sm font-semibold {% if order.workflow_status in 'stockkeeper_approved,packaging_in_progress,packaging_completed,delivery_in_progress,delivery_completed' %}text-green-700{% elif order.workflow_status == 'callcenter_approved' %}text-blue-700{% else %}text-gray-700{% endif %} mt-3">Stock</span>
                        <span class="text-xs {% if order.workflow_status in 'stockkeeper_approved,packaging_in_progress,packaging_completed,delivery_in_progress,delivery_completed' %}text-green-500{% elif order.workflow_status == 'callcenter_approved' %}text-blue-500{% else %}text-gray-500{% endif %}">Verified</span>
                    </div>
                    
                    <div class="hidden lg:block flex-1 h-1 {% if order.workflow_status in 'packaging_completed,delivery_in_progress,delivery_completed' %}bg-gradient-to-r from-green-300 to-purple-300{% else %}bg-gradient-to-r from-yellow-300 to-purple-300{% endif %} mx-4 rounded-full"></div>
                    <div class="lg:hidden w-1 h-16 {% if order.workflow_status in 'packaging_completed,delivery_in_progress,delivery_completed' %}bg-gradient-to-b from-green-300 to-purple-300{% else %}bg-gradient-to-b from-yellow-300 to-purple-300{% endif %} rounded-full"></div>
                    
                    <!-- Packaging -->
                    <div class="flex flex-col items-center group">
                        <div class="w-16 h-16 {% if order.workflow_status in 'packaging_completed,delivery_in_progress,delivery_completed' %}bg-gradient-to-br from-green-400 to-green-600{% elif order.workflow_status == 'stockkeeper_approved' %}bg-gradient-to-br from-yellow-400 to-amber-600{% else %}bg-gradient-to-br from-gray-400 to-gray-600{% endif %} rounded-full flex items-center justify-center shadow-lg group-hover:shadow-xl transition-all duration-300 group-hover:scale-110">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                            </svg>
                        </div>
                        <span class="text-sm font-semibold {% if order.workflow_status in 'packaging_completed,delivery_in_progress,delivery_completed' %}text-green-700{% elif order.workflow_status == 'stockkeeper_approved' %}text-amber-700{% else %}text-gray-700{% endif %} mt-3">Packaging</span>
                        <span class="text-xs {% if order.workflow_status in 'packaging_completed,delivery_in_progress,delivery_completed' %}text-green-500{% elif order.workflow_status == 'stockkeeper_approved' %}text-amber-500{% else %}text-gray-500{% endif %}">Completed</span>
                    </div>
                    
                    <div class="hidden lg:block flex-1 h-1 {% if order.workflow_status == 'delivery_completed' %}bg-gradient-to-r from-green-300 to-purple-300{% else %}bg-gradient-to-r from-purple-300 to-purple-300{% endif %} mx-4 rounded-full"></div>
                    <div class="lg:hidden w-1 h-16 {% if order.workflow_status == 'delivery_completed' %}bg-gradient-to-b from-green-300 to-purple-300{% else %}bg-gradient-to-b from-purple-300 to-purple-300{% endif %} rounded-full"></div>
                    
                    <!-- Delivery -->
                    <div class="flex flex-col items-center group">
                        <div class="w-16 h-16 {% if order.workflow_status == 'delivery_completed' %}bg-gradient-to-br from-green-400 to-green-600{% elif order.workflow_status == 'packaging_completed' %}bg-gradient-to-br from-purple-400 to-purple-600{% else %}bg-gradient-to-br from-gray-400 to-gray-600{% endif %} rounded-full flex items-center justify-center shadow-lg group-hover:shadow-xl transition-all duration-300 group-hover:scale-110">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <span class="text-sm font-semibold {% if order.workflow_status == 'delivery_completed' %}text-green-700{% elif order.workflow_status == 'packaging_completed' %}text-purple-700{% else %}text-gray-700{% endif %} mt-3">Delivery</span>
                        <span class="text-xs {% if order.workflow_status == 'delivery_completed' %}text-green-500{% elif order.workflow_status == 'packaging_completed' %}text-purple-500{% else %}text-gray-500{% endif %}">Completed</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Details -->
        <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl border border-amber-200/50 overflow-hidden">
            <div class="bg-gradient-to-r from-amber-500 to-yellow-500 px-6 py-4">
                <h3 class="text-xl font-bold text-white">Order Details</h3>
                <p class="text-amber-100 mt-1">Complete order information and specifications</p>
            </div>
            <div class="p-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Product Information -->
                    <div class="space-y-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Product Information</h4>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-3 border-b border-amber-100">
                                <span class="text-gray-600 font-medium">Product Name:</span>
                                <span class="text-gray-900 font-semibold">
                                    {% if order.product %}
                                        {{ order.product.name_en|default:order.product.name_ar }}
                                    {% else %}
                                        {% for item in order.items.all %}
                                            {{ item.product.name_en|default:item.product.name_ar }}{% if not forloop.last %}, {% endif %}
                                        {% empty %}
                                            N/A
                                        {% endfor %}
                                    {% endif %}
                                </span>
                            </div>
                            <div class="flex justify-between items-center py-3 border-b border-amber-100">
                                <span class="text-gray-600 font-medium">Product Code:</span>
                                <span class="text-gray-900 font-semibold">
                                    {% if order.product %}
                                        {{ order.product.code }}
                                    {% else %}
                                        {% for item in order.items.all %}
                                            {{ item.product.code }}{% if not forloop.last %}, {% endif %}
                                        {% empty %}
                                            N/A
                                        {% endfor %}
                                    {% endif %}
                                </span>
                            </div>
                            <div class="flex justify-between items-center py-3 border-b border-amber-100">
                                                        <span class="text-gray-600 font-medium">Description:</span>
                        <span class="text-gray-900 font-semibold">
                            {% if order.product %}
                                {{ order.product.description|truncatechars:50|default:"No Description" }}
                            {% else %}
                                {% for item in order.items.all %}
                                    {{ item.product.description|truncatechars:50|default:"No Description" }}{% if not forloop.last %}, {% endif %}
                                {% empty %}
                                    No Description
                                {% endfor %}
                            {% endif %}
                        </span>
                            </div>
                            <div class="flex justify-between items-center py-3 border-b border-amber-100">
                                <span class="text-gray-600 font-medium">Unit Price:</span>
                                <span class="text-gray-900 font-semibold">{{ order.unit_price|floatformat:2 }} AED</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customer Information -->
                    <div class="space-y-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Customer Information</h4>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-3 border-b border-amber-100">
                                <span class="text-gray-600 font-medium">Customer Name:</span>
                                <span class="text-gray-900 font-semibold">{{ order.customer|default:"N/A" }}</span>
                            </div>
                            {% if order.customer_phone %}
                            <div class="flex justify-between items-center py-3 border-b border-amber-100">
                                <span class="text-gray-600 font-medium">Phone:</span>
                                <span class="text-gray-900 font-semibold">{{ order.customer_phone }}</span>
                            </div>
                            {% endif %}
                            {% if order.customer_email %}
                            <div class="flex justify-between items-center py-3 border-b border-amber-100">
                                <span class="text-gray-600 font-medium">Email:</span>
                                <span class="text-gray-900 font-semibold">{{ order.customer_email }}</span>
                            </div>
                            {% endif %}
                            <div class="flex justify-between items-center py-3 border-b border-amber-100">
                                <span class="text-gray-600 font-medium">Order Date:</span>
                                <span class="text-gray-900 font-semibold">{{ order.date|date:"M d, Y" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workflow History -->
        {% if workflow_history %}
        <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl border border-amber-200/50 overflow-hidden">
            <div class="bg-gradient-to-r from-amber-500 to-yellow-500 px-6 py-4">
                <h3 class="text-xl font-bold text-white">Workflow History</h3>
                <p class="text-amber-100 mt-1">Complete timeline of order processing</p>
            </div>
            <div class="p-8">
                <div class="space-y-6">
                    {% for history in workflow_history %}
                    <div class="flex items-start space-x-4 p-4 bg-gradient-to-r from-amber-50 to-yellow-50 rounded-2xl border border-amber-200">
                        <div class="w-12 h-12 bg-gradient-to-br from-amber-400 to-yellow-500 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <h4 class="text-lg font-semibold text-gray-900">{{ history.get_status_change_reason_display|default:"Status Updated" }}</h4>
                                <span class="text-sm text-amber-600 font-medium">{{ history.timestamp|date:"M d, Y H:i" }}</span>
                            </div>
                            <p class="text-gray-600 mt-1">
                                {% if history.agent %}
                                    Updated by: {{ history.agent.full_name|default:history.agent.email }}
                                {% else %}
                                    System update
                                {% endif %}
                            </p>
                            {% if history.notes %}
                            <p class="text-gray-500 mt-2 italic">"{{ history.notes }}"</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
    /* Custom scrollbar for better UX */
    .overflow-x-auto::-webkit-scrollbar {
        height: 8px;
    }
    
    .overflow-x-auto::-webkit-scrollbar-track {
        background: #fef3c7;
        border-radius: 4px;
    }
    
    .overflow-x-auto::-webkit-scrollbar-thumb {
        background: linear-gradient(to right, #f59e0b, #eab308);
        border-radius: 4px;
    }
    
    .overflow-x-auto::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(to right, #d97706, #ca8a04);
    }
</style>
{% endblock %}
