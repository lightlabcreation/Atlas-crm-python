{% extends 'base.html' %}
{% load static %}

{% block title %}Two-Factor Authentication - Atlas Fulfillment{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
    <div class="sm:mx-auto sm:w-full sm:max-w-md">
        <div class="text-center">
            <img class="mx-auto h-12 w-auto" src="https://i.ibb.co/YT4Ny4L1/10.png" alt="Atlas Service">
            <h2 class="mt-6 text-3xl font-extrabold text-gray-900">Two-Factor Authentication</h2>
            <p class="mt-2 text-sm text-gray-600">Enter the 6-digit code from your authenticator app</p>
        </div>
    </div>

    <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
        <div class="bg-white py-8 px-4 shadow-sm border border-gray-200 sm:rounded-lg sm:px-10">
            <form id="verifyForm" class="space-y-6">
                {% csrf_token %}
                <div>
                    <label for="token" class="block text-sm font-medium text-gray-700">Verification Code</label>
                    <div class="mt-1">
                        <input id="token" name="token" type="text" maxlength="6" pattern="[0-9]{6}" 
                               class="form-input w-full text-center text-2xl tracking-widest" 
                               placeholder="000000" required autocomplete="off">
                    </div>
                    <p class="mt-2 text-sm text-gray-500">Enter the 6-digit code from your authenticator app</p>
                </div>

                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                            <i class="fas fa-shield-alt text-blue-500 group-hover:text-blue-400"></i>
                        </span>
                        Verify Code
                    </button>
                </div>
            </form>

            <div class="mt-6">
                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">Or use backup code</span>
                    </div>
                </div>

                <div class="mt-6">
                    <button type="button" onclick="toggleBackupCode()" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-key mr-2"></i>
                        Use Backup Code
                    </button>
                </div>
            </div>
        </div>

        <!-- Backup Code Form (Hidden by default) -->
        <div id="backupCodeForm" class="mt-4 bg-white py-8 px-4 shadow-sm border border-gray-200 sm:rounded-lg sm:px-10 hidden">
            <form id="backupForm" class="space-y-6">
                {% csrf_token %}
                <div>
                    <label for="backupCode" class="block text-sm font-medium text-gray-700">Backup Code</label>
                    <div class="mt-1">
                        <input id="backupCode" name="backupCode" type="text" 
                               class="form-input w-full text-center text-lg tracking-widest" 
                               placeholder="Enter backup code" required autocomplete="off">
                    </div>
                    <p class="mt-2 text-sm text-gray-500">Enter one of your backup codes</p>
                </div>

                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                            <i class="fas fa-key text-green-500 group-hover:text-green-400"></i>
                        </span>
                        Use Backup Code
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-sm rounded-lg bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                <i class="fas fa-spinner fa-spin text-blue-600"></i>
            </div>
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900">Verifying...</h3>
                <p class="text-sm text-gray-500">Please wait while we verify your code</p>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div id="errorModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-sm rounded-lg bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-exclamation-circle text-red-600"></i>
                        </div>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-lg font-medium text-gray-900">Verification Failed</h3>
                        <p class="text-sm text-gray-500" id="errorMessage">Please try again</p>
                    </div>
                </div>
                <button type="button" onclick="closeErrorModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="flex items-center justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
                <button type="button" onclick="closeErrorModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-times mr-2"></i>
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let isBackupMode = false;
    
    // Toggle backup code form
    function toggleBackupCode() {
        isBackupMode = !isBackupMode;
        const backupForm = document.getElementById('backupCodeForm');
        const verifyForm = document.getElementById('verifyForm');
        
        if (isBackupMode) {
            backupForm.classList.remove('hidden');
            verifyForm.classList.add('hidden');
        } else {
            backupForm.classList.add('hidden');
            verifyForm.classList.remove('hidden');
        }
    }
    
    // Verify form submission
    document.getElementById('verifyForm').addEventListener('submit', function(e) {
        e.preventDefault();
        verifyCode('token');
    });
    
    // Backup form submission
    document.getElementById('backupForm').addEventListener('submit', function(e) {
        e.preventDefault();
        verifyCode('backupCode');
    });
    
    // Verify code function
    function verifyCode(fieldName) {
        const token = document.getElementById(fieldName).value;
        const formData = new FormData();
        formData.append('token', token);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        showLoadingModal();
        
        fetch('{% url "users:verify_2fa_login" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoadingModal();
            if (data.success) {
                window.location.href = data.redirect_url;
            } else {
                showErrorModal(data.message);
            }
        })
        .catch(error => {
            hideLoadingModal();
            console.error('Error:', error);
            showErrorModal('An error occurred. Please try again.');
        });
    }
    
    // Modal functions
    function showLoadingModal() {
        document.getElementById('loadingModal').classList.remove('hidden');
    }
    
    function hideLoadingModal() {
        document.getElementById('loadingModal').classList.add('hidden');
    }
    
    function showErrorModal(message) {
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorModal').classList.remove('hidden');
    }
    
    function closeErrorModal() {
        document.getElementById('errorModal').classList.add('hidden');
    }
    
    // Auto-format token input
    document.getElementById('token').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });
    
    // Auto-format backup code input
    document.getElementById('backupCode').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^A-Z0-9]/g, '').toUpperCase();
    });
    
    // Focus on input when page loads
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('token').focus();
    });
</script>
{% endblock %}



















































