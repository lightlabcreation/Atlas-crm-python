{% extends 'base.html' %}

{% block title %}User Details - {{ user_obj.full_name }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Simple Header -->
    <div class="bg-gray-50 border-b border-gray-300">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-user text-orange-600 text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-semibold text-orange-600">User Details</h1>
                        <p class="mt-1 text-sm text-gray-500">{{ user_obj.full_name }}</p>
                    </div>
                </div>
                <div class="flex space-x-3">
                    {% if request.GET.from == 'sellers' %}
                    <a href="{% url 'sellers:seller_list' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Sellers
                    </a>
                    {% else %}
                    <a href="{% url 'users:list' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Users
                    </a>
                    {% endif %}
                    <a href="{% url 'users:edit' user_obj.id %}" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-edit mr-2"></i>
                        Edit User
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- User Summary Card -->
        <div class="bg-white rounded-lg border border-gray-200 shadow-sm mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">User Summary</h3>
            </div>
            <div class="p-6">
                <div class="flex items-center">
                    {% if user_obj.profile_image %}
                    <div class="w-20 h-20 mr-6">
                        <img src="{{ user_obj.profile_image.url }}" alt="{{ user_obj.full_name }}" class="w-20 h-20 rounded-full object-cover border-2 border-orange-500">
                    </div>
                    {% else %}
                    <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mr-6">
                        <span class="text-2xl font-bold text-orange-600">{{ user_obj.get_initials }}</span>
                    </div>
                    {% endif %}
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold text-gray-900">{{ user_obj.full_name }}</h2>
                        <p class="text-gray-600">{{ user_obj.email }}</p>
                        <div class="mt-2">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                                {% if user_obj.is_active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {% if user_obj.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-500">Member since</div>
                        <div class="text-lg font-semibold text-gray-900">{{ user_obj.date_joined|date:"M d, Y" }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- User Information -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg border border-gray-200 shadow-sm mb-6">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">User Information</h3>
                        <p class="text-sm text-gray-500">Personal details and contact information</p>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Full Name</label>
                                <p class="text-gray-900">{{ user_obj.full_name }}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Email Address</label>
                                <p class="text-gray-900">{{ user_obj.email }}</p>
                            </div>
                            {% if user_obj.phone_number %}
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Phone Number</label>
                                <p class="text-gray-900">{{ user_obj.phone_number }}</p>
                            </div>
                            {% endif %}
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Date Joined</label>
                                <p class="text-gray-900">{{ user_obj.date_joined|date:"M d, Y H:i" }}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Last Login</label>
                                <p class="text-gray-900">
                                    {% if user_obj.last_login %}
                                        {{ user_obj.last_login|date:"M d, Y H:i" }}
                                    {% else %}
                                        Never
                                    {% endif %}
                                </p>
                            </div>
                            {% if user_obj.country %}
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Country</label>
                                <p class="text-gray-900">{{ user_obj.country }}</p>
                            </div>
                            {% endif %}
                            {% if user_obj.company_name %}
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Company Name</label>
                                <p class="text-gray-900">{{ user_obj.company_name }}</p>
                            </div>
                            {% endif %}
                            {% if user_obj.expected_daily_orders %}
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Expected Daily Orders</label>
                                <p class="text-gray-900">{{ user_obj.expected_daily_orders }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Store Information -->
                {% if user_obj.store_name or user_obj.store_link or user_obj.store_type or user_obj.store_specialization or user_obj.marketing_platforms %}
                <div class="bg-white rounded-lg border border-gray-200 shadow-sm mb-6">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Store Information</h3>
                        <p class="text-sm text-gray-500">E-commerce store details and marketing</p>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {% if user_obj.store_name %}
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Store Name</label>
                                <p class="text-gray-900">{{ user_obj.store_name }}</p>
                            </div>
                            {% endif %}
                            {% if user_obj.store_type %}
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Store Type</label>
                                <p class="text-gray-900">{{ user_obj.get_store_type_display }}</p>
                            </div>
                            {% endif %}
                            {% if user_obj.store_link %}
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-500 mb-2">Store Link</label>
                                <a href="{{ user_obj.store_link }}" target="_blank" class="text-orange-600 hover:text-orange-800 break-all">
                                    {{ user_obj.store_link }} <i class="fas fa-external-link-alt ml-1 text-xs"></i>
                                </a>
                            </div>
                            {% endif %}
                            {% if user_obj.store_specialization %}
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-500 mb-2">Store Specialization</label>
                                <p class="text-gray-900">{{ user_obj.store_specialization }}</p>
                            </div>
                            {% endif %}
                            {% if user_obj.marketing_platforms %}
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-500 mb-2">Marketing Platforms</label>
                                <div class="flex flex-wrap gap-2">
                                    {% for platform in user_obj.marketing_platforms %}
                                    <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full bg-blue-100 text-blue-800">
                                        {{ platform }}
                                    </span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- ID Verification -->
                {% if user_obj.id_front_image or user_obj.id_back_image %}
                <div class="bg-white rounded-lg border border-gray-200 shadow-sm mb-6">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">ID Verification</h3>
                        <p class="text-sm text-gray-500">Uploaded identification documents</p>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {% if user_obj.id_front_image %}
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">ID Front Image</label>
                                <a href="{{ user_obj.id_front_image.url }}" target="_blank" class="block">
                                    <img src="{{ user_obj.id_front_image.url }}" alt="ID Front" class="w-full h-48 object-cover rounded-lg border border-gray-300 hover:border-orange-500 transition">
                                </a>
                            </div>
                            {% endif %}
                            {% if user_obj.id_back_image %}
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">ID Back Image</label>
                                <a href="{{ user_obj.id_back_image.url }}" target="_blank" class="block">
                                    <img src="{{ user_obj.id_back_image.url }}" alt="ID Back" class="w-full h-48 object-cover rounded-lg border border-gray-300 hover:border-orange-500 transition">
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Banking Information -->
                {% if user_obj.account_number or user_obj.bank_name or user_obj.account_holder_name %}
                <div class="bg-white rounded-lg border border-gray-200 shadow-sm mb-6">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Banking Information</h3>
                        <p class="text-sm text-gray-500">Bank details and payment information</p>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {% if user_obj.bank_name %}
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Bank Name</label>
                                <p class="text-gray-900">{{ user_obj.bank_name }}</p>
                            </div>
                            {% endif %}
                            {% if user_obj.account_holder_name %}
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Account Holder Name</label>
                                <p class="text-gray-900">{{ user_obj.account_holder_name }}</p>
                            </div>
                            {% endif %}
                            {% if user_obj.account_number %}
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-500 mb-2">IBAN</label>
                                <div class="bg-gray-50 rounded-lg p-4 border">
                                    <p class="font-mono text-lg text-gray-900 break-all">{{ user_obj.account_number }}</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Roles & Permissions -->
                <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Roles & Permissions</h3>
                        <p class="text-sm text-gray-500">User roles and system permissions</p>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Primary Role</label>
                                {% if user_obj.primary_role %}
                                    <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full bg-orange-100 text-orange-800">
                                        {{ user_obj.primary_role.name }}
                                    </span>
                                {% else %}
                                    <span class="text-gray-500">No Role Assigned</span>
                                {% endif %}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Account Status</label>
                                <div class="flex items-center space-x-4">
                                    <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full 
                                        {% if user_obj.is_active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                        {% if user_obj.is_active %}Active{% else %}Inactive{% endif %}
                                    </span>
                                    {% if user_obj.is_staff %}
                                    <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full bg-blue-100 text-blue-800">
                                        Staff
                                    </span>
                                    {% endif %}
                                    {% if user_obj.is_superuser %}
                                    <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full bg-purple-100 text-purple-800">
                                        Super User
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Approval Status -->
                <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Approval Status</h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Status</label>
                                <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full 
                                    {% if user_obj.approval_status == 'approved' %}bg-green-100 text-green-800
                                    {% elif user_obj.approval_status == 'rejected' %}bg-red-100 text-red-800
                                    {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                    {{ user_obj.get_approval_status_display }}
                                </span>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Email Verified</label>
                                <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full 
                                    {% if user_obj.email_verified %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                    {% if user_obj.email_verified %}Yes{% else %}No{% endif %}
                                </span>
                            </div>
                            {% if user_obj.approved_by %}
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Approved By</label>
                                <p class="text-sm text-gray-900">{{ user_obj.approved_by.full_name }}</p>
                            </div>
                            {% endif %}
                            {% if user_obj.approved_at %}
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Approved At</label>
                                <p class="text-sm text-gray-900">{{ user_obj.approved_at|date:"M d, Y H:i" }}</p>
                            </div>
                            {% endif %}
                            {% if user_obj.rejection_reason %}
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Rejection Reason</label>
                                <p class="text-sm text-gray-900">{{ user_obj.rejection_reason }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Quick Actions</h3>
                    </div>
                    <div class="p-6 space-y-3">
                        <a href="{% url 'users:edit' user_obj.id %}" 
                           class="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-md text-sm font-medium text-center block">
                            <i class="fas fa-edit mr-2"></i>
                            Edit User
                        </a>
                        {% if user_obj.is_active %}
                        <button data-user-id="{{ user_obj.id }}" data-action="deactivate"
                                class="action-btn w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            <i class="fas fa-user-times mr-2"></i>
                            Deactivate
                        </button>
                        {% else %}
                        <button data-user-id="{{ user_obj.id }}" data-action="activate"
                                class="action-btn w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            <i class="fas fa-user-check mr-2"></i>
                            Activate
                        </button>
                        {% endif %}
                        <a href="mailto:{{ user_obj.email }}" 
                           class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium text-center block">
                            <i class="fas fa-envelope mr-2"></i>
                            Send Email
                        </a>
                    </div>
                </div>

                <!-- User Statistics -->
                <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Statistics</h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">Login Count</span>
                                <span class="text-sm font-medium text-gray-900">{{ audit_logs|length }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">Account Age</span>
                                <span class="text-sm font-medium text-gray-900">{{ user_obj.date_joined|timesince }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Recent Activity</h3>
                    </div>
                    <div class="p-6">
                        {% if audit_logs %}
                        <div class="space-y-3">
                            {% for log in audit_logs|slice:":5" %}
                            <div class="flex items-center space-x-3">
                                <div class="w-2 h-2 bg-orange-500 rounded-full"></div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm text-gray-900 truncate">{{ log.description }}</p>
                                    <p class="text-xs text-gray-500">{{ log.timestamp|date:"M d, H:i" }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-sm text-gray-500">No recent activity</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full" id="modalIcon">
                <!-- Icon will be set dynamically -->
            </div>
            <h3 class="text-lg font-medium text-gray-900 mt-4" id="modalTitle">
                <!-- Title will be set dynamically -->
            </h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500" id="modalMessage">
                    <!-- Message will be set dynamically -->
                </p>
            </div>
            <div class="items-center px-4 py-3">
                <button id="confirmButton" 
                        class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-24 mr-2 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300">
                    Confirm
                </button>
                <button onclick="closeModal()" 
                        class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-24 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentAction = null;
let currentUserId = null;

function getCsrfToken() {
    const tokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
    if (tokenElement) {
        return tokenElement.value;
    }
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
    return cookieValue || '';
}

function showModal(title, message, iconClass, iconColor, action, userId) {
    currentAction = action;
    currentUserId = userId;
    
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalMessage').textContent = message;
    
    const icon = document.getElementById('modalIcon');
    icon.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full ${iconColor}`;
    icon.innerHTML = `<i class="${iconClass} text-2xl"></i>`;
    
    const confirmButton = document.getElementById('confirmButton');
    if (action === 'delete') {
        confirmButton.className = 'px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-24 mr-2 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300';
    } else if (action === 'deactivate') {
        confirmButton.className = 'px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-24 mr-2 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300';
    } else if (action === 'activate') {
        confirmButton.className = 'px-4 py-2 bg-green-600 text-white text-base font-medium rounded-md w-24 mr-2 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-300';
    }
    
    document.getElementById('confirmationModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('confirmationModal').classList.add('hidden');
    currentAction = null;
    currentUserId = null;
}

function confirmAction() {
    if (currentAction === 'deactivate') {
        deactivateUserConfirm();
    } else if (currentAction === 'activate') {
        activateUserConfirm();
    }
}

function deactivateUserConfirm() {
    fetch(`/users/${currentUserId}/toggle-status/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'An error occurred while updating the user status.');
        }
    })
    .catch(error => {
        alert('An error occurred while updating the user status.');
    });
    closeModal();
}

function activateUserConfirm() {
    fetch(`/users/${currentUserId}/toggle-status/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'An error occurred while updating the user status.');
        }
    })
    .catch(error => {
        alert('An error occurred while updating the user status.');
    });
    closeModal();
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('confirmButton').addEventListener('click', confirmAction);
    
    document.getElementById('confirmationModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    document.querySelectorAll('.action-btn').forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const action = this.getAttribute('data-action');
            
            if (action === 'deactivate') {
                showModal(
                    'Deactivate User',
                    'Are you sure you want to deactivate this user?',
                    'fas fa-user-times',
                    'bg-red-100',
                    'deactivate',
                    userId
                );
            } else if (action === 'activate') {
                showModal(
                    'Activate User',
                    'Are you sure you want to activate this user?',
                    'fas fa-user-check',
                    'bg-green-100',
                    'activate',
                    userId
                );
            }
        });
    });
});
</script>

{% csrf_token %}
{% endblock %}