{% load static %}
{% load user_filters %}
{% load i18n %}
<!-- Top Dark Strip -->
<div class="fixed top-0 left-0 right-0 z-50 bg-gray-800 h-1"></div>

<!-- Main Navigation Bar -->
<nav class="fixed top-1 left-0 right-0 z-50 bg-white border-b border-gray-200" style="direction: ltr !important;">
    <!-- Yellow Accent on Right -->
    <div class="w-full pl-4 pr-0 sm:pl-6 lg:pl-8">
        <div class="flex items-center justify-between h-16">
            <!-- Left Section: Navigation Links -->
            <div class="flex items-center space-x-8">
                <!-- Sidebar Toggle for Mobile -->
                <button id="sidebar-toggle" class="lg:hidden p-2 rounded text-gray-600 hover:text-gray-900 hover:bg-gray-100 mr-4">
                    <i class="fas fa-bars text-lg"></i>
                </button>

            </div>
            
            <!-- Center Section: Logo -->
            <a href="{% url 'landing:home' %}"
            class="flex items-center absolute left-1/2 transform -translate-x-1/2 -ml-8">
            <img src="https://i.ibb.co/YT4Ny4L1/10.png" class="h-8 w-15" />
        </a>
            

            <div class="flex items-center space-x-4 ml-auto pr-4">

                
                <!-- Language Selector -->
               
                
                <!-- Notifications -->
                <div class="relative">
                    <button id="notif-button" class="relative p-2 mt-1 rounded text-gray-600 hover:text-gray-900 hover:bg-gray-100">
                        <i class="fas fa-bell text-lg"></i>
                        <!-- Notification Badge - Dynamic unread count -->
                        <span id="notificationBadge" class="absolute -top-1 -right-1 flex h-4 w-4 {% if user.user_notifications.count == 0 %}hidden{% endif %}">
                            <span id="notificationCount" class="relative inline-flex rounded-full h-4 w-4 bg-red-500 text-xs text-white items-center justify-center font-bold">
                                {{ user.user_notifications.count }}
                            </span>
                        </span>
                    </button>
                    
                    <!-- Clean Notifications Dropdown -->
                    <div id="notif-dropdown" class="hidden absolute mt-2 w-80 bg-white rounded-lg border border-gray-200 shadow-lg z-50 right-0">
                        <div class="py-2">
                            <!-- Header -->
                            <div class="px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-bell text-yellow-500 text-sm"></i>
                                    <h3 class="text-sm font-semibold text-gray-900">Notifications</h3>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span id="notificationsCount" class="text-xs font-medium text-gray-600 bg-gray-100 px-2 py-1 rounded">
                                        {{ user.user_notifications.count }}
                                    </span>
                                    <button id="markAllReadBtn" class="text-xs text-yellow-600 hover:text-yellow-700">
                                        Mark All Read
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Enhanced Notifications List -->
                            <div id="notificationsList" class="max-h-80 overflow-y-auto custom-scrollbar">
                                {% if user.user_notifications.count > 0 %}
                                    <!-- Real notifications will be loaded here -->
                                    <div class="px-6 py-8 text-center">
                                        <div class="w-20 h-20 bg-gradient-to-br from-yellow-400 to-yellow-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                                            <i class="fas fa-bell text-white text-2xl"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 mb-2">{{ user.notifications.count }} Notifications</h3>
                                        <p class="text-sm text-gray-600">You have unread notifications</p>
                                    </div>
                                {% else %}
                                    <!-- No notifications state -->
                                    <div class="px-6 py-8 text-center">
                                        <div class="w-20 h-20 bg-gradient-to-br from-gray-300 to-gray-400 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-sm">
                                            <i class="fas fa-bell-slash text-white text-2xl"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 mb-2">All Caught Up!</h3>
                                        <p class="text-sm text-gray-600">No new notifications at the moment</p>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Enhanced Footer -->
                            <div class="px-6 py-3 border-t border-gray-200 bg-gray-50">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-600">Real-time updates</span>
                                    <a href="{% url 'notifications:index' %}" class="text-xs font-medium text-yellow-600 hover:text-yellow-700 hover:bg-yellow-50 px-2 py-1 rounded-md transition-all duration-200">
                                        <i class="fas fa-external-link-alt mr-1"></i>
                                        View All
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- User Profile Menu -->
                <div class="relative">
                    <button id="profile-button" class="flex items-center space-x-2 px-3 py-2 bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                        <div class="w-6 h-6 rounded-full flex items-center justify-center overflow-hidden">
                            {% if user.profile_image %}
                                <img src="{{ user.profile_image.url }}" alt="{{ user.get_full_name|default:user.username }}" class="w-full h-full object-cover">
                            {% else %}
                                <div class="w-full h-full bg-yellow-500 flex items-center justify-center">
                                    <i class="fas fa-user text-white text-xs"></i>
                                </div>
                            {% endif %}
                        </div>
                        <span class="text-sm font-medium">{{ user.get_full_name|default:user.username }}</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    
                    <!-- Clean User Menu Dropdown -->
                    <div id="user-menu" class="hidden absolute mt-2 w-128 bg-white rounded-lg border border-gray-200 shadow-lg z-50 right-0">
                        <div class="py-1">
                            <!-- User Info -->
                            <div class="px-4 py-3 border-b border-gray-200">
                                <div class="flex items-center space-x-3">
                                    {% if user.profile_image %}
                                        <img class="w-8 h-8 rounded-full object-cover" src="{{ user.profile_image.url }}" alt="{{ user.get_full_name|default:user.username }}">
                                    {% else %}
                                    <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center flex-shrink-0">
                                        <i class="fas fa-user text-white text-sm"></i>
                                    </div>
                                    
                                    {% endif %}
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">{{ user.get_full_name|default:user.username }}</div>
                                        <div class="text-xs text-gray-600 max-w-[150px] break-all truncate">
                                            {{ user.email }}
                                        </div>
                                        
                                        <!-- Role Display -->
                                        <div class="mt-1">
                                            {% if user.primary_role %}
                                                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                                                    {{ user.primary_role.name }}
                                                </span>
                                            {% elif user.user_roles.all %}
                                                {% with user.user_roles.all|first as first_role %}
                                                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                                                    {{ first_role.role.name }}
                                                </span>
                                                {% endwith %}
                                            {% elif user.is_admin %}
                                                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800">
                                                    Super Admin
                                                </span>
                                            {% else %}
                                                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                                    No Role
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Menu Items -->
                            <div class="py-1">
                                <a href="/users/profile/" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900">
                                    <i class="fas fa-user-circle mr-3 text-gray-500"></i>
                                    Profile
                                </a>
                                <a href="/settings/" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900">
                                    <i class="fas fa-cog mr-3 text-gray-500"></i>
                                    Settings
                                </a>
                                {% block language_switcherp %}
                                <div class="relative inline-block text-left w-full">
                                    <form method="post" action="{% url 'set_language' %}" id="langForm">
                                        {% csrf_token %}
                                        {% get_current_language as current_language %}
                                        <input type="hidden" name="language" id="languageInput" value="{{ current_language }}">
                
                                        <!-- الزر الرئيسي -->
                                        <button type="button"
                                            class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900"
                                            id="menu-button" aria-expanded="false" aria-haspopup="true" onclick="toggleDropdown(event)">
                
                                            {% if current_language == "ar" %}
                                            <div class="flex items-center gap-2 {% if LANGUAGE_CODE == 'ar' %}flex-row-reverse w-full{% else %}flex-row w-full{% endif %}">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="flex-shrink-0"
                                                    viewBox="0 0 512 512">
                                                    <mask id="mask-ar">
                                                        <circle cx="256" cy="256" r="256" fill="#fff" />
                                                    </mask>
                                                    <g mask="url(#mask-ar)">
                                                        <path fill="#a2001d" d="M0 0h167l52.3 252L167 512H0z" />
                                                        <path fill="#eee"
                                                            d="m167 167l170.8-44.6L512 167v178l-173.2 36.9L167 345z" />
                                                        <path fill="#6da544" d="M167 0h345v167H167z" />
                                                        <path fill="#333" d="M167 345h345v167H167z" />
                                                    </g>
                                                </svg>
                                                <span class="flex-grow text-left">العربية</span>
                                                <i class="fas fa-chevron-right text-xs text-gray-400 {% if LANGUAGE_CODE == 'ar' %}mr-auto rotate-180{% else %}ml-auto{% endif %}"></i>
                                            </div>
                                            {% else %}
                                            <div class="flex items-center gap-2 {% if LANGUAGE_CODE == 'ar' %}flex-row-reverse w-full{% else %}flex-row w-full{% endif %}">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="flex-shrink-0"
                                                    viewBox="0 0 512 512">
                                                    <mask id="mask-en">
                                                        <circle cx="256" cy="256" r="256" fill="#fff" />
                                                    </mask>
                                                    <g mask="url(#mask-en)">
                                                        <path fill="#eee"
                                                            d="M256 0h256v64l-32 32l32 32v64l-32 32l32 32v64l-32 32l32 32v64l-256 32L0 448v-64l32-32l-32-32v-64z" />
                                                        <path fill="#d80027"
                                                            d="M224 64h288v64H224Zm0 128h288v64H256ZM0 320h512v64H0Zm0 128h512v64H0Z" />
                                                        <path fill="#0052b4" d="M0 0h256v256H0Z" />
                                                        <path fill="#eee"
                                                            d="m187 243l57-41h-70l57 41l-22-67zm-81 0l57-41H93l57 41l-22-67zm-81 0l57-41H12l57 41l-22-67z" />
                                                    </g>
                                                </svg>
                                                <span class="flex-grow text-left">English</span>
                                                <i class="fas fa-chevron-right text-xs text-gray-400 {% if LANGUAGE_CODE == 'ar' %}mr-auto{% else %}ml-auto{% endif %}"></i>
                                            </div>
                                            {% endif %}
                                        </button>
            
                                        <!-- القائمة المنسدلة -->
                                        <div id="langDropdown"
                                        class="hidden absolute z-[60] w-44 bg-white shadow-lg rounded-xl ring-1 ring-black ring-opacity-5 focus:outline-none
                                               {% if LANGUAGE_CODE == 'ar' %}
                                               left-full ml-1 top-0
                                               md:left-auto md:right-0 md:ml-0 md:mt-2 md:top-full
                                               {% else %}
                                               right-full mr-1 top-0
                                               md:right-0 md:mr-0 md:mt-2 md:top-full
                                               {% endif %}">
                                            <div class="py-1">
            
                                                <!-- English -->
                                                <button type="button" onclick="setLanguage('en')"
                                                    class="flex items-center gap-2 {% if LANGUAGE_CODE == 'ar' %}flex-row-reverse{% else %}flex-row{% endif %} w-full px-4 py-2 text-sm text-left text-gray-700 hover:bg-gray-100 transition-all duration-300 rounded-md {% if current_language == 'en' %}font-bold{% endif %}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                        viewBox="0 0 512 512">
                                                        <mask id="mask-en2">
                                                            <circle cx="256" cy="256" r="256" fill="#fff" />
                                                        </mask>
                                                        <g mask="url(#mask-en2)">
                                                            <path fill="#eee"
                                                                d="M256 0h256v64l-32 32l32 32v64l-32 32l32 32v64l-32 32l32 32v64l-256 32L0 448v-64l32-32l-32-32v-64z" />
                                                            <path fill="#d80027"
                                                                d="M224 64h288v64H224Zm0 128h288v64H256ZM0 320h512v64H0Zm0 128h512v64H0Z" />
                                                            <path fill="#0052b4" d="M0 0h256v256H0Z" />
                                                        </g>
                                                    </svg>
                                                    <span>English</span>
                                                </button>
            
                                                <!-- Arabic -->
                                                <button type="button" onclick="setLanguage('ar')"
                                                    class="flex items-center gap-2 {% if LANGUAGE_CODE == 'ar' %}flex-row-reverse{% else %}flex-row{% endif %} w-full px-4 py-2 text-sm text-left text-gray-700 hover:bg-gray-100 transition-all duration-300 rounded-md {% if current_language == 'ar' %}font-bold{% endif %}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                        viewBox="0 0 512 512">
                                                        <mask id="mask-ar2">
                                                            <circle cx="256" cy="256" r="256" fill="#fff" />
                                                        </mask>
                                                        <g mask="url(#mask-ar2)">
                                                            <path fill="#a2001d" d="M0 0h167l52.3 252L167 512H0z" />
                                                            <path fill="#eee"
                                                                d="m167 167l170.8-44.6L512 167v178l-173.2 36.9L167 345z" />
                                                            <path fill="#6da544" d="M167 0h345v167H167z" />
                                                            <path fill="#333" d="M167 345h345v167H167z" />
                                                        </g>
                                                    </svg>
                                                    <span>العربية</span>
                                                </button>
            
                                            </div>
                                        </div>
                                    </form>
                                </div>
            
                                <script>
                                    function toggleDropdown() {
                                        const dropdown = document.getElementById('langDropdown');
                                        dropdown.classList.toggle('hidden');
                                    }
            
                                    function setLanguage(lang) {
                                        document.getElementById('languageInput').value = lang;
                                        document.getElementById('langForm').submit();
                                    }
            
                                    window.addEventListener('click', function (e) {
                                        const dropdown = document.getElementById('langDropdown');
                                        const button = document.getElementById('menu-button');
                                        if (!button.contains(e.target) && !dropdown.contains(e.target)) {
                                            dropdown.classList.add('hidden');
                                        }
                                    });
                                </script>
                                {% endblock %}
                            </div>
                            
                            <!-- Logout -->
                            <div class="border-t border-gray-200 pt-1">
                                <a href="/users/logout/" class="flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50 hover:text-red-700">
                                    <i class="fas fa-sign-out-alt mr-3"></i>
                                    Sign Out
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Separator Line -->
    <div class="w-full h-px bg-gray-200"></div>
</nav>

<!-- Spacer to prevent content from going under fixed navbar -->


<!-- Custom Scrollbar Styles -->
<style>
.custom-scrollbar::-webkit-scrollbar {
    width: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: rgba(51, 65, 85, 0.3);
    border-radius: 3px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background: linear-gradient(to bottom, #f59e0b, #eab308);
    border-radius: 3px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(to bottom, #d97706, #ca8a04);
}

/* Enhanced Notification Styles */
.notification-item {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.notification-item:hover {
    transform: translateX(4px);
}

.notification-item.unread {
    background: linear-gradient(90deg, rgba(245, 158, 11, 0.05) 0%, transparent 100%);
    border-left: 3px solid #f59e0b;
}

.notification-item.read {
    background: transparent;
    border-left: 3px solid transparent;
}

/* Notification Badge Animation */
@keyframes notification-pulse {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.1);
        opacity: 0.8;
    }
}

#notificationBadge .animate-ping {
    animation: notification-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

/* Enhanced Button Styles */
.notification-action-btn {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.notification-action-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(245, 158, 11, 0.2), transparent);
    transition: left 0.5s;
}

.notification-action-btn:hover::before {
    left: 100%;
}

.notification-action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

/* Ensure dropdowns are visible */
#notif-dropdown, #user-menu {
    position: absolute !important;
    top: 100% !important;
    right: 0 !important;
    z-index: 9999 !important;
    min-width: 200px;
    background: white !important;
    backdrop-filter: blur(16px) !important;
    border: 1px solid rgb(229 231 235) !important;
    border-radius: 12px !important;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15) !important;
    overflow: hidden;
}

/* Style dropdown content for light theme */
#notif-dropdown *, #user-menu * {
    color: #374151 !important;
}

#notif-dropdown .text-gray-600, #user-menu .text-gray-600 {
    color: #6b7280 !important;
}

#notif-dropdown .text-gray-500, #user-menu .text-gray-500 {
    color: #9ca3af !important;
}

#notif-dropdown .text-gray-700, #user-menu .text-gray-700 {
    color: #374151 !important;
}

#notif-dropdown .text-gray-900, #user-menu .text-gray-900 {
    color: #111827 !important;
}

/* Fix notification items */
.notification-item {
    color: #374151 !important;
    background: transparent !important;
}

.notification-item:hover {
    background: rgba(243, 244, 246, 0.8) !important;
}

/* Fix user menu items */
.user-menu-item {
    color: #374151 !important;
    background: transparent !important;
}

.user-menu-item:hover {
    background: rgba(243, 244, 246, 0.8) !important;
}

#notif-dropdown {
    width: 320px !important;
}

#user-menu {
    width: 224px !important;
    overflow: visible !important;
}

/* Ensure dropdowns are above other elements */
.header-nav {
    position: relative;
    z-index: 1000;
}

/* Fix positioning for mobile */
@media (max-width: 768px) {
    #notif-dropdown, #user-menu {
        right: 0 !important;
        left: auto !important;
        width: calc(100vw - 2rem) !important;
        max-width: 320px;
    }
}
        
</style>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Notification dropdown toggle
    const notificationButton = document.getElementById('notif-button');
    const notificationDropdown = document.getElementById('notif-dropdown');
    const notificationCountSpan = document.getElementById('notificationCount');
    const notificationsCountSpan = document.getElementById('notificationsCount');
    const unreadCountSpan = document.getElementById('unreadCount');
    const notificationsList = document.getElementById('notificationsList');

    if (notificationButton && notificationDropdown) {
        notificationButton.addEventListener('click', function() {
            notificationDropdown.classList.toggle('hidden');
            // Load notifications when dropdown is opened
            if (!notificationDropdown.classList.contains('hidden')) {
                loadNotifications();
            }
        });
    }

    // Add event listener for Mark All Read button
    const markAllReadBtn = document.getElementById('markAllReadBtn');
    if (markAllReadBtn) {
        markAllReadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            markAllNotificationsRead();
        });
    }

    // Load notifications from backend
    function loadNotifications() {
        // Check if notification elements exist on the page
        if (document.getElementById('notificationCount') || 
            document.getElementById('notificationsCount') || 
            document.getElementById('unreadCount') || 
            document.getElementById('notificationsList')) {
            fetch('/notifications/get/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateNotificationUI(data);
                    }
                })
                .catch(error => {
                    console.error('Error loading notifications:', error);
                });
        }
    }

    // Update notification UI
    function updateNotificationUI(data) {
        const { notifications, unread_count } = data;
        
        // Get DOM elements with null checks
        const notificationCountSpan = document.getElementById('notificationCount');
        const notificationBadge = document.getElementById('notificationBadge');
        const notificationsCountSpan = document.getElementById('notificationsCount');
        const notificationsList = document.getElementById('notificationsList');
        
        // Update notification badge
        if (notificationCountSpan && notificationBadge) {
            if (unread_count > 0) {
                notificationCountSpan.textContent = unread_count;
                notificationBadge.classList.remove('hidden');
            } else {
                notificationBadge.classList.add('hidden');
            }
        }
        
        // Update notifications count in header
        if (notificationsCountSpan) {
            notificationsCountSpan.textContent = notifications.length;
        }
        
        // Update notifications list with enhanced UI
        if (notificationsList) {
            if (notifications.length > 0) {
                notificationsList.innerHTML = notifications.map(notification => `
                    <div class="px-4 py-4 border-b border-gray-200 last:border-b-0 hover:bg-gray-50 transition-all duration-200 ${notification.is_read ? 'opacity-60' : ''}">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center ${notification.is_read ? 'bg-gray-200' : 'bg-yellow-100'}">
                                    <i class="fas ${getNotificationIcon(notification.notification_type)} text-sm ${notification.is_read ? 'text-gray-500' : 'text-yellow-600'}"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between mb-1">
                                    <h4 class="text-sm font-semibold text-gray-900 truncate">${notification.title}</h4>
                                    ${!notification.is_read ? 
                                        '<span class="inline-block w-2 h-2 bg-red-500 rounded-full flex-shrink-0 ml-2"></span>' : ''
                                    }
                                </div>
                                <p class="text-sm text-gray-700 mb-2 leading-relaxed">${notification.message}</p>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-500">${formatNotificationTime(notification.created_at)}</span>
                                    ${!notification.is_read ? 
                                        `<button onclick="markNotificationRead(${notification.id})" class="text-xs text-yellow-600 hover:text-yellow-700 font-medium transition-colors duration-200 hover:bg-yellow-50 px-2 py-1 rounded-md">
                                            <i class="fas fa-check mr-1"></i>Mark as Read
                                        </button>` : 
                                        '<span class="text-xs text-gray-400 italic">Read</span>'
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                notificationsList.innerHTML = `
                    <div class="px-4 py-8 text-center">
                        <div class="h-16 w-16 bg-gradient-to-br from-gray-300 to-gray-400 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                            <i class="fas fa-bell-slash text-white text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">All Caught Up!</h3>
                        <p class="text-sm text-gray-600">No new notifications at the moment</p>
                    </div>
                `;
            }
        }
    }

    // Helper function to get notification icon based on type
    function getNotificationIcon(type) {
        const icons = {
            'product_approved': 'fa-check-circle',
            'product_rejected': 'fa-times-circle',
            'new_order': 'fa-shopping-cart',
            'order_status_changed': 'fa-sync-alt',
            'system': 'fa-info-circle'
        };
        return icons[type] || 'fa-bell';
    }

    // Helper function to format notification time
    function formatNotificationTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
    }

    // Mark notification as read
    window.markNotificationRead = function(notificationId) {
        fetch(`/notifications/mark-read/${notificationId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the specific notification UI immediately
                const notificationElement = document.querySelector(`[onclick="markNotificationRead(${notificationId})"]`).closest('.px-4');
                if (notificationElement) {
                    // Update the notification to show as read
                    notificationElement.classList.add('opacity-60');
                    notificationElement.querySelector('.w-8.h-8').classList.remove('bg-yellow-100');
                    notificationElement.querySelector('.w-8.h-8').classList.add('bg-gray-200');
                    notificationElement.querySelector('.w-8.h-8 i').classList.remove('text-yellow-600');
                    notificationElement.querySelector('.w-8.h-8 i').classList.add('text-gray-500');
                    
                    // Replace the button with "Read" text
                    const buttonContainer = notificationElement.querySelector('.flex.items-center.justify-between');
                    const button = buttonContainer.querySelector('button');
                    if (button) {
                        button.replaceWith('<span class="text-xs text-gray-400 italic">Read</span>');
                    }
                    
                    // Remove the unread indicator
                    const unreadIndicator = notificationElement.querySelector('.w-2.h-2.bg-red-500');
                    if (unreadIndicator) {
                        unreadIndicator.remove();
                    }
                }
                
                // Reload notifications to update counts
                loadNotifications();
            }
        })
        .catch(error => {
            console.error('Error marking notification as read:', error);
        });
    };

    // Mark all notifications as read
    function markAllNotificationsRead() {
        fetch('/notifications/mark-all-read/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update all notifications to show as read
                const notificationElements = document.querySelectorAll('#notificationsList .px-4');
                notificationElements.forEach(element => {
                    element.classList.add('opacity-60');
                    const iconContainer = element.querySelector('.w-8.h-8');
                    if (iconContainer) {
                        iconContainer.classList.remove('bg-yellow-100');
                        iconContainer.classList.add('bg-gray-200');
                        const icon = iconContainer.querySelector('i');
                        if (icon) {
                            icon.classList.remove('text-yellow-600');
                            icon.classList.add('text-gray-500');
                        }
                    }
                    
                    // Replace all buttons with "Read" text
                    const buttons = element.querySelectorAll('button');
                    buttons.forEach(button => {
                        button.replaceWith('<span class="text-xs text-gray-400 italic">Read</span>');
                    });
                    
                    // Remove all unread indicators
                    const unreadIndicators = element.querySelectorAll('.w-2.h-2.bg-red-500');
                    unreadIndicators.forEach(indicator => {
                        indicator.remove();
                    });
                });
                
                // Reload notifications to update counts
                loadNotifications();
            }
        })
        .catch(error => {
            console.error('Error marking all notifications as read:', error);
        });
    }

    // Load notifications on page load
    loadNotifications();
    
    // Refresh notifications every 30 seconds
    setInterval(loadNotifications, 30000);
    
    // Profile dropdown toggle
    const profileButton = document.getElementById('profile-button');
    const profileDropdown = document.getElementById('user-menu');
    
    if (profileButton && profileDropdown) {
        profileButton.addEventListener('click', function() {
            profileDropdown.classList.toggle('hidden');
        });
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        // Close notification dropdown
        if (notificationButton && notificationDropdown && !notificationButton.contains(event.target) && !notificationDropdown.contains(event.target)) {
            notificationDropdown.classList.add('hidden');
        }
        
        // Close profile dropdown
        if (profileButton && profileDropdown && !profileButton.contains(event.target) && !profileDropdown.contains(event.target)) {
            profileDropdown.classList.add('hidden');
        }
    });

    // Close dropdowns when pressing Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            if (notificationDropdown && !notificationDropdown.classList.contains('hidden')) {
                notificationDropdown.classList.add('hidden');
            }
            if (profileDropdown && !profileDropdown.classList.contains('hidden')) {
                profileDropdown.classList.add('hidden');
            }
        }
    });

    // Set browser info
    const browserInfo = `${navigator.userAgent} - ${navigator.platform}`;
    if (document.getElementById('bug-browser-info')) {
        document.getElementById('bug-browser-info').value = browserInfo;
    }
});
</script>
{% endblock %}
