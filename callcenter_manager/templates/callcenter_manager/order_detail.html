{% extends 'base.html' %}

{% block title %}Order Detail - #{{ order.order_code }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header Section -->
    <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-file-alt text-orange-500 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <h1 class="text-2xl font-bold text-orange-500">Order Detail</h1>
                        <p class="text-gray-600">Order #{{ order.order_code }}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="{% url 'callcenter_manager:orders_management' %}" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Orders
                    </a>
                    <a href="{% url 'callcenter_manager:order_edit' order.id %}" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-edit mr-2"></i>
                        Edit Order
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Order Status Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-shopping-cart text-blue-500 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <h2 class="text-xl font-bold text-gray-900">Order Status</h2>
                        <p class="text-gray-600">Current status and workflow information</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="px-4 py-2 text-sm font-medium rounded-full
                        {% if order.status == 'pending' %}bg-yellow-100 text-yellow-800
                        {% elif order.status == 'processing' %}bg-blue-100 text-blue-800
                        {% elif order.status == 'confirmed' %}bg-green-100 text-green-800
                        {% elif order.status == 'completed' %}bg-green-100 text-green-800
                        {% elif order.status == 'cancelled' %}bg-red-100 text-red-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ order.get_status_display }}
                    </span>
                    <p class="text-sm text-gray-500 mt-1">{{ order.created_at|date:"M d, Y H:i" }}</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Order Information -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Basic Information -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center mb-6">
                        <i class="fas fa-info-circle text-blue-600 text-xl mr-3"></i>
                        <h3 class="text-lg font-medium text-gray-900">Order Information</h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Order Code</label>
                            <p class="mt-1 text-sm text-gray-900 font-mono">#{{ order.order_code }}</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Order Date</label>
                            <p class="mt-1 text-sm text-gray-900">{{ order.created_at|date:"F d, Y" }}</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Order Time</label>
                            <p class="mt-1 text-sm text-gray-900">{{ order.created_at|time:"H:i" }}</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Last Updated</label>
                            <p class="mt-1 text-sm text-gray-900">{{ order.updated_at|date:"M d, Y H:i" }}</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Workflow Status</label>
                            <p class="mt-1 text-sm text-gray-900">{{ order.get_workflow_status_display }}</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Priority</label>
                            <span class="mt-1 inline-flex px-2 py-1 text-xs font-medium rounded-full
                                {% if order.priority == 'high' %}bg-red-100 text-red-800
                                {% elif order.priority == 'medium' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-green-100 text-green-800{% endif %}">
                                {{ order.get_priority_display|default:"Normal" }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Customer Information -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center mb-6">
                        <i class="fas fa-user text-green-600 text-xl mr-3"></i>
                        <h3 class="text-lg font-medium text-gray-900">Customer Information</h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Customer Name</label>
                            <p class="mt-1 text-sm text-gray-900">{{ order.customer }}</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Phone Number</label>
                            <p class="mt-1 text-sm text-gray-900">
                                <a href="tel:{{ order.customer_phone }}" class="text-blue-600 hover:text-blue-800">
                                    {{ order.customer_phone }}
                                </a>
                            </p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Email</label>
                            <p class="mt-1 text-sm text-gray-900">
                                {% if order.customer_email %}
                                    <a href="mailto:{{ order.customer_email }}" class="text-blue-600 hover:text-blue-800">
                                        {{ order.customer_email }}
                                    </a>
                                {% else %}
                                    <span class="text-gray-400 italic">Not provided</span>
                                {% endif %}
                            </p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Address</label>
                            <p class="mt-1 text-sm text-gray-900">
                                {% if order.customer_address %}
                                    {{ order.customer_address }}
                                {% else %}
                                    <span class="text-gray-400 italic">Not provided</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Product Information -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center mb-6">
                        <i class="fas fa-box text-purple-600 text-xl mr-3"></i>
                        <h3 class="text-lg font-medium text-gray-900">Product Information</h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Product Name</label>
                            <p class="mt-1 text-sm text-gray-900">{{ order.product_name }}</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Quantity</label>
                            <p class="mt-1 text-sm text-gray-900">{{ order.quantity }}</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Price per Unit</label>
                            <p class="mt-1 text-sm text-gray-900">{{ order.price_per_unit|floatformat:2 }} AED</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Total Price</label>
                            <p class="mt-1 text-sm text-gray-900 font-bold text-lg">
                                {% widthratio order.price_per_unit 1 order.quantity %} AED
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Notes and Comments -->
                {% if order.notes %}
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center mb-6">
                        <i class="fas fa-sticky-note text-yellow-600 text-xl mr-3"></i>
                        <h3 class="text-lg font-medium text-gray-900">Notes & Comments</h3>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-sm text-gray-700 whitespace-pre-line">{{ order.notes }}</p>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Sidebar -->
            <div class="space-y-8">
                <!-- Agent Assignment -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center mb-6">
                        <i class="fas fa-user-tie text-indigo-600 text-xl mr-3"></i>
                        <h3 class="text-lg font-medium text-gray-900">Agent Assignment</h3>
                    </div>
                    
                    {% if order.agent %}
                        <div class="text-center">
                            <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-user text-indigo-600 text-2xl"></i>
                            </div>
                            <h4 class="text-lg font-medium text-gray-900">{{ order.agent.get_full_name|default:order.agent.email }}</h4>
                            <p class="text-sm text-gray-500">{{ order.agent.email }}</p>
                            <div class="mt-4">
                                <span class="px-3 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                                    Assigned
                                </span>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-user-slash text-gray-400 text-2xl"></i>
                            </div>
                            <h4 class="text-lg font-medium text-gray-500">Unassigned</h4>
                            <p class="text-sm text-gray-500">No agent assigned to this order</p>
                            <div class="mt-4">
                                <span class="px-3 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">
                                    Pending Assignment
                                </span>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Seller Information -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center mb-6">
                        <i class="fas fa-store text-green-600 text-xl mr-3"></i>
                        <h3 class="text-lg font-medium text-gray-900">Seller Information</h3>
                    </div>
                    
                    {% if order.seller %}
                        <div class="text-center">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-store text-green-600 text-2xl"></i>
                            </div>
                            <h4 class="text-lg font-medium text-gray-900">{{ order.seller.get_full_name|default:order.seller.email }}</h4>
                            <p class="text-sm text-gray-500">{{ order.seller.email }}</p>
                            {% if order.seller_phone %}
                                <p class="text-sm text-gray-500">{{ order.seller_phone }}</p>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="text-center">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-store text-gray-400 text-2xl"></i>
                            </div>
                            <h4 class="text-lg font-medium text-gray-500">No Seller</h4>
                            <p class="text-sm text-gray-500">Order created by system</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center mb-6">
                        <i class="fas fa-bolt text-orange-600 text-xl mr-3"></i>
                        <h3 class="text-lg font-medium text-gray-900">Quick Actions</h3>
                    </div>
                    
                    <div class="space-y-3">
                        <a href="{% url 'callcenter_manager:order_edit' order.id %}" 
                           class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-md text-sm font-medium text-center block">
                            <i class="fas fa-edit mr-2"></i>
                            Edit Order
                        </a>
                        
                        {% if order.agent %}
                            <a href="{% url 'callcenter:manager_reassign_order' order.id %}" 
                               class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium text-center block">
                                <i class="fas fa-user-plus mr-2"></i>
                                Reassign Agent
                            </a>
                        {% else %}
                            <a href="{% url 'callcenter:manager_assign_order' order.id %}" 
                               class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium text-center block">
                                <i class="fas fa-user-plus mr-2"></i>
                                Assign Agent
                            </a>
                        {% endif %}
                        
                        <a href="{% url 'callcenter:manager_log_call' order.id %}" 
                           class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium text-center block">
                            <i class="fas fa-phone mr-2"></i>
                            Call Customer
                        </a>
                        
                        <button onclick="openAddNoteModal()" class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                            <i class="fas fa-comment mr-2"></i>
                            Add Note
                        </button>
                    </div>
                </div>

                <!-- Order Timeline -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center mb-6">
                        <i class="fas fa-clock text-blue-600 text-xl mr-3"></i>
                        <h3 class="text-lg font-medium text-gray-900">Order Timeline</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-plus text-green-600 text-sm"></i>
                                </div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-900">Order Created</p>
                                <p class="text-sm text-gray-500">{{ order.created_at|date:"M d, Y H:i" }}</p>
                            </div>
                        </div>
                        
                        {% if order.updated_at != order.created_at %}
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-edit text-blue-600 text-sm"></i>
                                </div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-900">Last Updated</p>
                                <p class="text-sm text-gray-500">{{ order.updated_at|date:"M d, Y H:i" }}</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if order.agent %}
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-purple-600 text-sm"></i>
                                </div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-900">Agent Assigned</p>
                                <p class="text-sm text-gray-500">{{ order.agent.get_full_name|default:order.agent.email }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Note Modal -->
<div id="addNoteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Add Note</h3>
                <button onclick="closeAddNoteModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form method="post" action="{% url 'callcenter_manager:add_note' order.id %}">
                {% csrf_token %}
                <div class="mb-4">
                    <label for="note_type" class="block text-sm font-medium text-gray-700 mb-2">Note Type</label>
                    <select name="note_type" id="note_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="general">General</option>
                        <option value="customer_issue">Customer Issue</option>
                        <option value="internal">Internal Note</option>
                        <option value="follow_up">Follow Up Required</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="note_content" class="block text-sm font-medium text-gray-700 mb-2">Note Content</label>
                    <textarea name="note_content" id="note_content" rows="4" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Enter your note here..." required></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeAddNoteModal()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                        Add Note
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Call Logs Section -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
        <div class="flex items-center mb-6">
            <div class="flex-shrink-0">
                <i class="fas fa-phone text-green-500 text-xl mr-3"></i>
            </div>
            <div>
                <h3 class="text-lg font-medium text-gray-900">سجل الاتصالات</h3>
                <p class="text-gray-600">تاريخ جميع الاتصالات مع العميل</p>
            </div>
        </div>
        
        {% if order.call_logs.all %}
            <div class="space-y-4">
                {% for call_log in order.call_logs.all %}
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-3">
                            <span class="text-sm font-medium text-gray-900">
                                {{ call_log.agent.get_full_name|default:call_log.agent.username }}
                            </span>
                            <span class="px-2 py-1 text-xs font-medium rounded-full
                                {% if call_log.status == 'completed' %}bg-green-100 text-green-800
                                {% elif call_log.status == 'no_answer' %}bg-yellow-100 text-yellow-800
                                {% elif call_log.status == 'busy' %}bg-red-100 text-red-800
                                {% elif call_log.status == 'wrong_number' %}bg-red-100 text-red-800
                                {% elif call_log.status == 'voicemail' %}bg-blue-100 text-blue-800
                                {% elif call_log.status == 'call_back' %}bg-purple-100 text-purple-800
                                {% elif call_log.status == 'escalated' %}bg-orange-100 text-orange-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ call_log.get_status_display }}
                            </span>
                            <span class="px-2 py-1 text-xs font-medium rounded-full
                                {% if call_log.resolution_status == 'resolved' %}bg-green-100 text-green-800
                                {% elif call_log.resolution_status == 'pending' %}bg-yellow-100 text-yellow-800
                                {% elif call_log.resolution_status == 'escalated' %}bg-red-100 text-red-800
                                {% elif call_log.resolution_status == 'follow_up_required' %}bg-blue-100 text-blue-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ call_log.get_resolution_status_display }}
                            </span>
                        </div>
                        <div class="text-sm text-gray-500">
                            {{ call_log.call_time|date:"M d, Y H:i" }}
                        </div>
                    </div>
                    
                    {% if call_log.notes %}
                    <div class="mt-2">
                        <p class="text-sm text-gray-700">{{ call_log.notes }}</p>
                    </div>
                    {% endif %}
                    
                    {% if call_log.escalation_reason %}
                    <div class="mt-2 bg-red-50 p-2 rounded">
                        <p class="text-xs font-medium text-red-800">سبب التصعيد:</p>
                        <p class="text-xs text-red-700">{{ call_log.escalation_reason }}</p>
                    </div>
                    {% endif %}
                    
                    {% if call_log.duration > 0 %}
                    <div class="mt-2 text-xs text-gray-500">
                        <i class="fas fa-clock mr-1"></i>
                        مدة الاتصال: {{ call_log.duration }} ثانية
                    </div>
                    {% endif %}
                    
                    {% if call_log.customer_satisfaction %}
                    <div class="mt-2 text-xs text-gray-500">
                        <i class="fas fa-star mr-1"></i>
                        تقييم العميل: {{ call_log.customer_satisfaction }}/5
                    </div>
                    {% endif %}
                    
                    {% if call_log.follow_up_date %}
                    <div class="mt-2 text-xs text-gray-500">
                        <i class="fas fa-calendar mr-1"></i>
                        موعد المتابعة: {{ call_log.follow_up_date|date:"M d, Y H:i" }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-8">
                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-phone text-gray-400"></i>
                </div>
                <p class="text-gray-500 text-sm">لا توجد اتصالات مسجلة لهذا الطلب</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
function openAddNoteModal() {
    document.getElementById('addNoteModal').classList.remove('hidden');
}

function closeAddNoteModal() {
    document.getElementById('addNoteModal').classList.add('hidden');
}

// Close modal when clicking outside
document.getElementById('addNoteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeAddNoteModal();
    }
});
</script>

{% endblock %}