{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}Edit Product - {{ product.name_en }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Simple Header -->
    <div class="bg-gray-50 border-b border-gray-300">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-edit text-orange-600 text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-semibold text-orange-600">Edit Product</h1>
                        <p class="mt-1 text-sm text-gray-500">{{ product.name_en }}</p>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <a href="{% url 'sellers:product_detail' product.id %}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-eye mr-2"></i>
                        View Product
                    </a>
                    <a href="{% url 'sellers:products' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Products
                    </a>
                    <a href="{% url 'sellers:dashboard' %}" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-home mr-2"></i>
                        Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Product Form -->
        <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Product Information</h3>
                <p class="text-sm text-gray-500">Update the product details below</p>
            </div>
            
            <form method="post" enctype="multipart/form-data" class="p-6 space-y-6" id="product-edit-form">
                {% csrf_token %}
                
                <!-- Basic Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="name_en" class="block text-sm font-medium text-gray-700 mb-2">Product Name (English)</label>
                        <input type="text" name="name_en" id="name_en" value="{{ product.name_en }}" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                               placeholder="{% trans 'Enter product name in English' %}">
                    </div>
                    
                    <div>
                        <label for="name_ar" class="block text-sm font-medium text-gray-700 mb-2">Product Name (Arabic)</label>
                        <input type="text" name="name_ar" id="name_ar" value="{{ product.name_ar }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                               placeholder="{% trans 'Enter product name in Arabic' %}">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="code" class="block text-sm font-medium text-gray-700 mb-2">Product Code</label>
                        <input type="text" name="code" id="code" value="{{ product.code }}" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                               placeholder="{% trans 'Enter product code' %}">
                    </div>
                    
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <select name="category" id="category" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            <option value="">Select category</option>
                            <option value="electronics" {% if product.category == 'electronics' %}selected{% endif %}>Electronics</option>
                            <option value="clothing" {% if product.category == 'clothing' %}selected{% endif %}>Clothing</option>
                            <option value="home" {% if product.category == 'home' %}selected{% endif %}>Home & Garden</option>
                            <option value="sports" {% if product.category == 'sports' %}selected{% endif %}>Sports</option>
                            <option value="books" {% if product.category == 'books' %}selected{% endif %}>Books</option>
                            <option value="beauty" {% if product.category == 'beauty' %}selected{% endif %}>Beauty</option>
                            <option value="toys" {% if product.category == 'toys' %}selected{% endif %}>Toys</option>
                            <option value="other" {% if product.category == 'other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                </div>

                <!-- Pricing Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="purchase_price" class="block text-sm font-medium text-gray-700 mb-2">Purchase Price (AED)</label>
                        <input type="number" name="purchase_price" id="purchase_price" value="{{ product.purchase_price }}" step="0.01" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                               placeholder="0.00">
                    </div>
                    
                    <div>
                        <label for="selling_price" class="block text-sm font-medium text-gray-700 mb-2">Selling Price (AED)</label>
                        <input type="number" name="selling_price" id="selling_price" value="{{ product.selling_price }}" step="0.01" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                               placeholder="0.00">
                    </div>
                </div>

                <!-- Inventory Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="stock_quantity" class="block text-sm font-medium text-gray-700 mb-2">Stock Quantity</label>
                        <input type="number" name="stock_quantity" id="stock_quantity" value="{{ product.stock_quantity }}" min="0" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                               placeholder="0">
                    </div>
                    
                    <div>
                        <label for="product_link" class="block text-sm font-medium text-gray-700 mb-2">Product Link</label>
                        <input type="url" name="product_link" id="product_link" value="{{ product.product_link }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                               placeholder="https://example.com/product">
                    </div>
                </div>

                <!-- Product Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea name="description" id="description" rows="4"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                              placeholder="{% trans 'Enter product description' %}">{{ product.description }}</textarea>
                </div>

                <!-- Current Image -->
                {% if product.image %}
                {% with image_url=product.get_image_url %}
                {% if image_url %}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Current Image</label>
                    <div class="mt-1">
                        <div class="relative inline-block">
                            <img src="{{ image_url }}" 
                                 alt="{{ product.name_en }}" 
                                 class="h-32 w-32 object-cover rounded-lg border-2 border-gray-200 shadow-sm"
                                 onerror="this.onerror=null; this.src=''; this.parentElement.innerHTML='<div class=\'h-32 w-32 bg-gray-100 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300\'><i class=\'fas fa-image text-gray-400 text-2xl\'></i></div>';">
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endwith %}
                {% endif %}

                <!-- Product Image -->
                <div>
                    <label for="image" class="block text-sm font-medium text-gray-700 mb-2">Product Image</label>
                    <input type="file" name="image" id="image" accept="image/*"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                    <p class="mt-1 text-sm text-gray-500">Upload a new product image (JPG, PNG, GIF)</p>
                </div>


                <!-- Form Actions -->
                <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
                    <a href="{% url 'sellers:product_detail' product.id %}" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-md text-sm font-medium">
                        Cancel
                    </a>
                    <button type="submit" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-save mr-2"></i>
                        Update Product
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Image preview functionality
    const imageInput = document.getElementById('image');
    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            console.log('Image selected:', file);
            
            if (file) {
                console.log('File details:', {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    sizeMB: (file.size / 1024 / 1024).toFixed(2) + ' MB'
                });
                
                // Check if file is an image
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file (JPG, PNG, GIF)');
                    e.target.value = '';
                    return;
                }
                
                // Check file size (10MB limit)
                if (file.size > 10 * 1024 * 1024) {
                    alert('Image file size must be under 10MB');
                    e.target.value = '';
                    return;
                }
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Remove existing preview if any
                    const existingPreview = document.getElementById('image-preview');
                    if (existingPreview) {
                        existingPreview.remove();
                    }
                    
                    // Create preview element
                    const previewDiv = document.createElement('div');
                    previewDiv.id = 'image-preview';
                    previewDiv.className = 'mt-3';
                    previewDiv.innerHTML = `
                        <label class="block text-sm font-medium text-gray-700 mb-2">Image Preview</label>
                        <div class="relative inline-block">
                            <img src="${e.target.result}" alt="Preview" class="h-32 w-32 object-cover rounded-lg border-2 border-gray-200 shadow-sm">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">File: ${file.name} (${(file.size / 1024).toFixed(2)} KB)</p>
                    `;
                    
                    // Insert after image input
                    imageInput.parentElement.appendChild(previewDiv);
                };
                reader.readAsDataURL(file);
            } else {
                console.log('No file selected');
            }
        });
    }
    
    // Form submission debugging
    const form = document.getElementById('product-edit-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const imageInput = document.getElementById('image');
            if (imageInput && imageInput.files.length > 0) {
                console.log('Form submitting with image:', {
                    fileName: imageInput.files[0].name,
                    fileSize: imageInput.files[0].size,
                    fileType: imageInput.files[0].type
                });
            } else {
                console.log('Form submitting without new image');
            }
        });
    }
    
    // Calculate profit margin automatically
    const purchasePriceInput = document.getElementById('purchase_price');
    const sellingPriceInput = document.getElementById('selling_price');

    function calculateProfitMargin() {
        const purchasePrice = parseFloat(purchasePriceInput.value) || 0;
        const sellingPrice = parseFloat(sellingPriceInput.value) || 0;
        
        if (purchasePrice > 0 && sellingPrice > 0) {
            const profit = sellingPrice - purchasePrice;
            const margin = (profit / purchasePrice) * 100;
            console.log(`Profit: ${profit.toFixed(2)} AED, Margin: ${margin.toFixed(2)}%`);
        }
    }

    // Calculate initial profit margin
    calculateProfitMargin();

    purchasePriceInput.addEventListener('input', calculateProfitMargin);
    sellingPriceInput.addEventListener('input', calculateProfitMargin);
});
</script>
{% endblock %}