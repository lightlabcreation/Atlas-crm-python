{% extends "base.html" %}
{% load static %}

{% block title %}Receiving Shipments - Stock Keeper{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
                <div class="flex">
        <!-- Main Content -->
        <div class="flex-1">
            <div class="p-8">
                <!-- Header -->
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-6">Receiving Shipments</h1>
                    
                    <!-- Type Selection Buttons -->
                    <div class="flex gap-4 mb-6">
                        <a href="?type=client_stock{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" 
                           class="inline-flex items-center px-6 py-3 {% if receiving_type == 'client_stock' %}bg-blue-600 text-white{% else %}bg-white text-gray-700 border border-gray-300{% endif %} text-sm font-medium rounded-lg hover:bg-blue-700">
                            <i class="fas fa-user mr-2"></i>
                            Client Stock-In
                        </a>
                        <a href="?type=sourcing{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" 
                           class="inline-flex items-center px-6 py-3 {% if receiving_type == 'sourcing' %}bg-blue-600 text-white{% else %}bg-white text-gray-700 border border-gray-300{% endif %} text-sm font-medium rounded-lg hover:bg-blue-700">
                            <i class="fas fa-building mr-2"></i>
                            Sourcing Purchase
                        </a>
                    </div>
                    
                    <!-- Period Selection -->
                    <div class="flex justify-end mb-6">
                        <button onclick="openPeriodModal()" class="inline-flex items-center px-4 py-2 {% if date_from or date_to %}bg-gray-900 text-white border-gray-900{% else %}bg-white border-gray-300{% endif %} border rounded-lg text-sm font-medium hover:bg-gray-50">
                            <i class="fas fa-calendar-alt mr-2"></i>
                            Select Period
                        </button>
        </div>

                    <!-- Barcode Scanner Section -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Scan Barcode</h3>
                        <div class="flex gap-4 items-center">
                                <div class="flex-1">
                                <input type="text" 
                                       id="barcode-scanner" 
                                       placeholder="Scan or enter barcode..." 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       onkeypress="handleBarcodeScan(event)">
                                <p class="text-xs text-gray-500 mt-2">Scan product barcode to receive stock</p>
                            </div>
                            <button onclick="openReceiveForm()" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700">
                                <i class="fas fa-plus mr-2"></i>
                                Manual Entry
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search Section -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                        <div class="flex gap-4 items-center">
                                <div class="flex-1">
                                <input type="text" 
                                       id="receipt-search" 
                                       placeholder="Enter Receiving Order Number (SIR-...)" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <p class="text-xs text-gray-500 mt-2">Example: SIR-2025-046</p>
                            </div>
                            <button onclick="searchReceipt()" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700">
                                <i class="fas fa-search mr-2"></i>
                                Search
                            </button>
                        </div>
            </div>
        </div>

                <!-- Recent Receivings Table -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Recent Receivings</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">GRN Number</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% if recent_receivings %}
                                    {% for movement in recent_receivings %}
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">GRN-S-{{ movement.id|stringformat:"05d" }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ movement.created_at|date:"Y-m-d" }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {% if movement.product.seller %}
                                                {{ movement.product.seller.get_full_name|default:movement.product.seller.email|default:"Supplier" }}
                                            {% else %}
                                                {{ movement.reference_number|default:"Supplier" }}
                                            {% endif %}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                <i class="fas fa-check-circle mr-1"></i>
                                                Completed
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <div class="flex gap-2">
                                                <button onclick="viewReceiving({{ movement.id }})" class="text-blue-600 hover:text-blue-900">View</button>
                                                <button onclick="printLabel({{ movement.id }}, '{{ movement.reference_number|default:movement.tracking_number }}')" class="text-purple-600 hover:text-purple-900" title="Print Label">
                                                    <i class="fas fa-print"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                            {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="5" class="px-6 py-10 text-center text-sm text-gray-500">
                                            <div class="flex flex-col items-center">
                                                <i class="fas fa-inbox text-4xl text-gray-300 mb-2"></i>
                                                <p>No recent receivings</p>
                    </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
                    </div>

<!-- Period Modal -->
<div id="periodModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Select Period</h3>
                <button onclick="closePeriodModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form method="get" id="periodForm">
                <input type="hidden" name="type" value="{{ receiving_type }}">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                        <input type="date" name="date_from" value="{{ date_from }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                        <input type="date" name="date_to" value="{{ date_to }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Apply
                    </button>
                    <button type="button" onclick="closePeriodModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Define all functions directly on window to ensure they're accessible from onclick handlers
window.searchReceipt = function() {
    try {
        const searchInput = document.getElementById('receipt-search');
        if (!searchInput) {
            alert('Search input not found');
            return;
        }
        const searchTerm = searchInput.value.trim();
        if (!searchTerm) {
            alert('Please enter a receiving order number');
            return;
        }
        // Search for movement by reference number
        window.location.href = `?search=${encodeURIComponent(searchTerm)}&type={{ receiving_type }}`;
    } catch (error) {
        console.error('Error in searchReceipt:', error);
        alert('Error searching: ' + error.message);
    }
};

window.viewReceiving = function(movementId) {
    try {
        // Redirect to movement detail or show modal
        window.location.href = `/stock-keeper/movement-history/?movement_id=${movementId}`;
    } catch (error) {
        console.error('Error in viewReceiving:', error);
        alert('Error viewing receiving: ' + error.message);
    }
};

window.handleBarcodeScan = function(event) {
    try {
        if (event.key === 'Enter') {
            const barcodeInput = document.getElementById('barcode-scanner');
            if (!barcodeInput) return;
            
            const barcode = barcodeInput.value.trim();
            if (barcode) {
                // Search for product by barcode/code
                fetch(`/stock-keeper/api/search-product/?q=${encodeURIComponent(barcode)}`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Network error');
                    return response.json();
                })
    .then(data => {
                    if (data.success && data.products && data.products.length > 0) {
                        const product = data.products[0];
                        window.openReceiveForm(product.id, product.name, product.code);
        } else {
                        alert('Product not found. Please enter manually.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
                    alert('Error searching product. Please enter manually.');
                });
            }
        }
    } catch (error) {
        console.error('Error in handleBarcodeScan:', error);
    }
};

window.openReceiveForm = function(productId = null, productName = '', productCode = '') {
    try {
        // Open receive form modal with product pre-filled if provided
        alert('Receive form will open here. Product: ' + (productName || 'New'));
        // TODO: Implement receive form modal
    } catch (error) {
        console.error('Error in openReceiveForm:', error);
    }
};

window.printLabel = function(movementId, referenceNumber) {
    try {
        const printWindow = window.open('', '_blank');
        if (!printWindow) {
            alert('Please allow popups to print label');
        return;
        }
        const htmlContent = '<html>' +
            '<head>' +
            '<title>Shipping Label - ' + referenceNumber + '</title>' +
            '<style>' +
            '@media print { @page { size: 4in 6in; margin: 0.25in; } }' +
            'body { font-family: Arial, sans-serif; padding: 20px; }' +
            '.label { border: 2px solid #000; padding: 15px; text-align: center; }' +
            '.barcode { font-family: "Courier New", monospace; font-size: 24px; margin: 10px 0; }' +
            '.reference { font-size: 18px; font-weight: bold; margin: 10px 0; }' +
            '</style>' +
            '</head>' +
            '<body>' +
            '<div class="label">' +
            '<div class="reference">' + referenceNumber + '</div>' +
            '<div class="barcode">*' + referenceNumber + '*</div>' +
            '<div>Receiving Label</div>' +
            '<div>Date: ' + new Date().toLocaleDateString() + '</div>' +
            '</div>' +
            '<scr' + 'ipt>' +
            'window.onload = function() {' +
            'window.print();' +
            'setTimeout(function() { window.close(); }, 1000);' +
            '};' +
            '</scr' + 'ipt>' +
            '</body>' +
            '</html>';
        printWindow.document.write(htmlContent);
        printWindow.document.close();
    } catch (error) {
        console.error('Error in printLabel:', error);
        alert('Error printing label: ' + error.message);
    }
};

window.openPeriodModal = function() {
    try {
        const modal = document.getElementById('periodModal');
        if (modal) {
            modal.classList.remove('hidden');
        } else {
            alert('Period modal not found');
        }
    } catch (error) {
        console.error('Error in openPeriodModal:', error);
    }
};

window.closePeriodModal = function() {
    try {
        const modal = document.getElementById('periodModal');
        if (modal) {
            modal.classList.add('hidden');
        }
    } catch (error) {
        console.error('Error in closePeriodModal:', error);
    }
};
</script>
{% endblock %} 
